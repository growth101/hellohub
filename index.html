<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <title>HelloHub - Alex Davis Care Group</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px;
            position: relative;
            transition: all 0.5s ease;
            /* Enhanced iPad Safari fixes */
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* Prevent iPad Safari bounce/scroll issues */
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            /* Fix iPad rendering issues */
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        
        /* iPad-specific body fixes */
        @media (max-width: 1024px) {
            body {
                /* Ensure proper rendering on iPad */
                min-height: -webkit-fill-available;
                min-height: fill-available;
                /* Fix iPad Safari viewport issues */
                position: fixed;
                width: 100%;
                overflow: hidden;
            }
        }
        
        /* Fix for iPad Safari 100vh issues */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
        }
        
        /* Background images for each location */
        body.location-the-royal {
            background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('the-royal-exterior.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        body.location-the-crown {
            background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('the-crown-exterior.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        body.location-seabreeze {
            background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('seabreeze-exterior.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        /* Remove the old Alex Davis logo background when location photos are shown */
        body.location-the-royal::before,
        body.location-the-crown::before,
        body.location-seabreeze::before {
            display: none;
        }
        
        body.alex-davis-logged-in::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            height: 45vw;
            max-width: 800px;
            max-height: 400px;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDQwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxlbGxpcHNlIGN4PSIyMDAiIGN5PSIxMDAiIHJ4PSIxOTAiIHJ5PSI5MCIgZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjQzBDMEMwIiBzdHJva2Utd2lkdGg9IjMiLz4KPHN2ZyB4PSI1MCIgeT0iMzAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMTQwIj4KICA8IS0tIENyb3duIC0tPgogIDxwYXRoIGQ9Ik0yNTAgNDAgTDI2MCAzMCBMMjcwIDQwIEwyNjggNTAgTDI3MCA2MCBMMjYwIDUwIEwyNTAgNjAiIGZpbGw9IiNEQUE1MjAiLz4KICA8IS0tIEFsZXhEYXZpcyBUZXh0IC0tPgogIDx0ZXh0IHg9IjE1IiB5PSI4NSIgZm9udC1mYW1pbHk9InNlcmlmIiBmb250LXNpemU9IjM2IiBmb250LXN0eWxlPSJpdGFsaWMiIGZpbGw9IndoaXRlIj5BbGV4RGF2aXM8L3RleHQ+CiAgPCEtLSBIYW5kIC0tPgogIDxwYXRoIGQ9Ik0xMDAgMTEwIEwxMzAgMTAwIEwxNDUgMTA1IEwxNTAgMTEwIEwxNDUgMTE1IEwxMzAgMTIwIEwxMDAgMTMwIFoiIGZpbGw9IiNEQUE1MjAiLz4KICA8IS0tIENBUkUgR1JPVVAgVGV4dCAtLT4KICA8dGV4dCB4PSI4MCIgeT0iMTI1IiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiBsZXR0ZXItc3BhY2luZz0iM3B4Ij5DQVJFIEJST1VQPC90ZXh0Pgo8L3N2Zz4KPC9zdmc+');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.25;
            z-index: -1;
            pointer-events: none;
        }
        .container {
            background: rgba(255, 255, 255, 0.5); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 500px; width: 100%; min-height: 600px; position: relative;
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            /* Enhanced iPad compatibility */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            /* Ensure container is accessible on iPad */
            overflow: visible;
        }
        
        /* iPad-specific container fixes */
        @media (max-width: 1024px) {
            .container {
                /* Ensure container fits properly on iPad */
                max-height: 90vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                /* Fix positioning issues on iPad */
                margin: 20px auto;
                /* Prevent container from being cut off */
                position: relative;
                z-index: 1;
            }
        }
        
        /* Ensure login page is always accessible on iPad */
        #loginPage {
            /* Fix any potential z-index issues */
            position: relative;
            z-index: 10;
        }
        
        /* iPad Safari form fixes */
        @media (max-width: 1024px) {
            #loginPage form {
                /* Ensure form is properly positioned */
                position: relative;
                z-index: 20;
            }
        }
        .header {
            background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; padding: 40px 30px; text-align: center; border-radius: 20px 20px 0 0;
            position: relative;
        }
        .header h1 { font-size: 24px; margin-bottom: 8px; opacity: 0.9; font-weight: 600; }
        .header p { opacity: 1; font-size: 36px; font-weight: bold; margin-bottom: 8px; }
        .header .location-name { font-size: 42px; font-weight: bold; opacity: 1; margin-top: 8px; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header .company-logo {
            max-height: 80px;
            max-width: 280px;
            width: auto;
            height: auto;
            margin-bottom: 20px;
            object-fit: contain;
            display: none;
        }
        .content { padding: 40px; position: relative; min-height: 400px; }
        .admin-logo {
            position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);
            cursor: pointer; user-select: none; z-index: 100;
        }
        .page { display: none; }
        .page.active { display: block; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 14px; }
        .required { color: #e74c3c; }
        input, select {
            width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px;
            font-size: 16px; background: #f8f9fa; transition: all 0.3s ease;
            /* Enhanced iOS Safari styling fixes */
            -webkit-appearance: none;
            -webkit-border-radius: 12px;
            -moz-appearance: none;
            appearance: none;
            /* Prevent zoom on focus for mobile devices - CRITICAL FOR IPAD */
            font-size: 16px;
            /* Improve touch handling */
            touch-action: manipulation;
            /* Fix iOS Safari text selection and input issues */
            -webkit-user-select: text;
            user-select: text;
            /* Prevent iOS Safari from adding its own styling */
            background-clip: padding-box;
            /* Fix iOS Safari border rendering */
            border-style: solid;
            /* Ensure consistent box model on iOS */
            box-sizing: border-box;
            /* Fix iOS input field rendering issues */
            -webkit-rtl-ordering: logical;
            -webkit-text-security: none;
        }
        
        /* iPad-specific input fixes */
        @media (max-width: 1024px) {
            input, select {
                /* Ensure inputs work properly on iPad */
                -webkit-tap-highlight-color: rgba(0,0,0,0);
                /* Fix iPad Safari input focus issues */
                -webkit-user-modify: read-write-plaintext-only;
            }
        }
        
        /* Specific fixes for email and password inputs on iPad */
        input[type="email"], input[type="password"] {
            /* Prevent iOS Safari from interfering with these input types */
            -webkit-text-security: none;
            text-security: none;
            /* Fix autocomplete issues on iPad */
            -webkit-autocomplete: on;
            autocomplete: on;
        }
        
        input[type="password"] {
            /* Ensure password field works correctly on iPad */
            -webkit-text-security: disc;
            text-security: disc;
        }
        
        /* Business dropdown specific styling with down arrow */
        #businessDropdown {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23666' d='M1.5 0L6 4.5L10.5 0L12 1.5L6 7.5L0 1.5L1.5 0Z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px 8px;
            padding-right: 45px;
            cursor: pointer;
        }
        
        #businessDropdown:focus {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%2374b9ff' d='M1.5 0L6 4.5L10.5 0L12 1.5L6 7.5L0 1.5L1.5 0Z'/%3E%3C/svg%3E");
        }
        input:focus, select:focus {
            outline: none; border-color: #74b9ff; background: white; box-shadow: 0 0 0 3px rgba(116, 185, 255, 0.1);
        }
        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold;
            cursor: pointer; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease;
            /* Enhanced touch handling for mobile devices - CRITICAL FOR IPAD */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            /* Fix iPad Safari button rendering */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* Ensure buttons work on touchscreens */
            position: relative;
            /* Fix iOS Safari button focus issues */
            -webkit-focus-ring-color: transparent;
            outline: none;
            /* Prevent iOS Safari text selection on buttons */
            -webkit-touch-callout: none;
            /* Fix iPad button click delay */
            -webkit-user-drag: none;
            /* Ensure consistent rendering on iOS */
            background-clip: padding-box;
            border: 1px solid transparent;
        }
        
        /* iPad-specific button improvements */
        @media (max-width: 1024px) {
            .btn {
                /* Larger touch targets for iPad */
                min-height: 50px;
                /* Remove iOS Safari default button styling */
                -webkit-appearance: none;
                -webkit-border-radius: 12px;
                /* Fix touch response issues */
                -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            }
            
            .btn:active {
                /* Provide immediate visual feedback on iPad */
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
        }
        .btn-primary { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; }
        .btn-success { background: linear-gradient(135deg, #00b894, #00a085); color: white; }
        .btn-warning { background: linear-gradient(135deg, #fdcb6e, #e17055); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { transform: translateY(-2px); }
        .user-type-selection { display: flex; gap: 10px; margin-bottom: 30px; }
        .user-type-btn {
            flex: 1; padding: 20px; border: 2px solid #e0e0e0; border-radius: 12px; background: #f8f9fa;
            cursor: pointer; text-align: center; transition: all 0.3s ease;
        }
        .user-type-btn:hover { border-color: #74b9ff; background: white; }
        .user-type-btn.active { border-color: #74b9ff; background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; }
        .alert { padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .alert-success { background: #d1f2eb; color: #00695c; border: 1px solid #a7f3d0; }
        .alert-info { background: #e3f2fd; color: #0277bd; border: 1px solid #b3e5fc; }
        .countdown { margin-top: 15px; font-size: 16px; font-weight: bold; color: #0277bd; }
        
        /* Client Dropdown Styles */
        .client-dropdown {
            position: relative;
            width: 100%;
        }
        
        .client-select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .client-select::after {
            content: '‚ñº';
            color: #666;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .client-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #74b9ff;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .client-option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .client-option:hover {
            background: #f8f9fa;
        }
        
        .client-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            border: 2px solid #e0e0e0;
        }
        
        .client-name {
            font-weight: bold;
            color: #333;
        }
        
        .settings-icon {
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            color: #6c757d;
            font-size: 18px;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .settings-icon:hover {
            background: rgba(255,255,255,0.2);
            color: #333;
        }
        
        /* Client Management Styles */
        .client-management {
            padding: 20px;
        }
        
        .client-list {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .client-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .client-card-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid #e0e0e0;
        }
        
        .client-card-info {
            flex: 1;
        }
        
        .client-card-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .client-card-location {
            color: #6c757d;
            font-size: 14px;
        }
        
        .client-card-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            margin: 0;
            width: auto;
        }
        
        .photo-upload {
            position: relative;
            margin-bottom: 15px;
        }
        
        .photo-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e0e0e0;
            margin: 0 auto 15px;
            display: block;
        }
        
        .upload-btn {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .upload-btn input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        /* Feedback Form Styles */
        .feedback-question {
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.06);
        }
        
        .feedback-label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 15px;
            line-height: 1.4;
        }
        
        .star-rating {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .star {
            font-size: 32px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.3;
            transform: scale(1);
        }
        
        .star:hover {
            transform: scale(1.1);
            opacity: 0.8;
        }
        
        .star.selected {
            opacity: 1;
            filter: drop-shadow(0 2px 4px rgba(255, 193, 7, 0.3));
        }
        
        .star.selected ~ .star {
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="alex-davis-logo.png" alt="Alex Davis Care Group Logo" class="company-logo" id="headerLogo">
            <h1 id="headerTitle">üëã HelloHub</h1>
            <p id="headerSubtitle">Visitor, Client & Staff Management</p>
            <div id="locationName" class="location-name" style="display: none;"></div>
        </div>
        <div class="content">
            <div class="admin-logo" onclick="adminReset()">
                <svg width="80" height="50" viewBox="0 0 400 200">
                    <rect x="20" y="40" width="200" height="120" rx="25" ry="25" fill="#000000"/>
                    <circle cx="120" cy="85" r="15" fill="white"/>
                    <ellipse cx="120" cy="120" rx="12" ry="20" fill="white"/>
                    <path d="M140 95 Q148 90 152 95 Q156 100 150 105 Q144 110 140 105 Q136 100 140 95" fill="white"/>
                    <path d="M50 160 L35 180 L65 160 Z" fill="#000000"/>
                    <text x="250" y="110" font-family="Arial" font-size="32" font-weight="bold" fill="#000000">HelloHub</text>
                </svg>
            </div>
<div id="loginPage" class="page active">
  <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Company Login</h2>
  <form id="loginForm" onsubmit="return handleLoginSubmit(event);" novalidate>
    <div class="form-group">
      <label for="emailAddress">Email Address:</label>
      <input type="email" id="emailAddress" name="emailAddress" placeholder="Enter your company email" 
             autocomplete="username" autocapitalize="none" autocorrect="off" spellcheck="false" 
             data-testid="email-input" />
    </div>
    <div class="form-group">
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" placeholder="Enter your password" 
             autocomplete="current-password" autocapitalize="none" autocorrect="off" spellcheck="false"
             data-testid="password-input" />
    </div>
    <button class="btn btn-primary" type="submit" id="loginButton" data-testid="login-button">üîê Login</button>
  </form>
  <div id="loginError" style="display: none; color: #e74c3c; text-align: center; margin-top: 15px; font-size: 14px;"></div>
  
  <!-- iPad Troubleshooting Section -->
  <div id="iPadTroubleshooting" style="margin-top: 20px; text-align: center;">
    <button type="button" class="btn" onclick="showIPadDiagnostics()" 
            style="background: #6c757d; color: white; font-size: 12px; padding: 8px 16px; margin: 0; width: auto; text-transform: none; letter-spacing: normal;">
      iPad Not Working? Tap for Help
    </button>
  </div>
</div>
            <div id="businessSelect" class="page">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Select Location</h2>
                <div class="form-group">
                    <label for="businessDropdown">Choose Business Location:</label>
                    <select id="businessDropdown" onchange="doSelectBusiness()">
                        <option value="">-- Select Location --</option>
                    </select>
                </div>
            </div>

            <div id="userTypeSelect" class="page">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">I am a...</h2>
                <div class="user-type-selection">
                    <div class="user-type-btn" onclick="doSelectUserType('visitor')">
                        <div style="font-size: 24px; margin-bottom: 10px;">üë•</div>
                        <div style="font-weight: bold;">Visitor</div>
                    </div>
                    <div class="user-type-btn" onclick="doSelectUserType('client')">
                        <div style="font-size: 24px; margin-bottom: 10px;">ü§ù</div>
                        <div style="font-weight: bold;">Client</div>
                    </div>
                    <div class="user-type-btn" onclick="doSelectUserType('staff')">
                        <div style="font-size: 24px; margin-bottom: 10px;">üë®‚Äçüíº</div>
                        <div style="font-weight: bold;">Staff</div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-primary" onclick="doShowAction('arriving')">Arriving</button>
                    <button class="btn btn-warning" onclick="doShowAction('leaving')">Leaving</button>
                </div>
            </div>

            <div id="arrivingPage" class="page">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Arriving</h2>
                <div id="arrivalForm"></div>
            </div>

            <div id="leavingPage" class="page">
                <!-- Content will be dynamically generated -->
            </div>

            <div id="feedbackPage" class="page">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Your Feedback Matters</h2>
                <div class="alert alert-info">Please rate the care home in terms of number of stars, with 5 stars being best</div>
                
                <form id="feedbackForm">
                    <div class="feedback-question">
                        <label class="feedback-label">How would you rate the care home overall?</label>
                        <div class="star-rating" data-question="overall">
                            <span class="star" data-rating="1">‚≠ê</span>
                            <span class="star" data-rating="2">‚≠ê</span>
                            <span class="star" data-rating="3">‚≠ê</span>
                            <span class="star" data-rating="4">‚≠ê</span>
                            <span class="star" data-rating="5">‚≠ê</span>
                        </div>
                    </div>

                    <div class="feedback-question">
                        <label class="feedback-label">Do you feel the care home keeps people safe?</label>
                        <div class="star-rating" data-question="safety">
                            <span class="star" data-rating="1">‚≠ê</span>
                            <span class="star" data-rating="2">‚≠ê</span>
                            <span class="star" data-rating="3">‚≠ê</span>
                            <span class="star" data-rating="4">‚≠ê</span>
                            <span class="star" data-rating="5">‚≠ê</span>
                        </div>
                    </div>

                    <div class="feedback-question">
                        <label class="feedback-label">Do you feel the care home is responsive to people's needs?</label>
                        <div class="star-rating" data-question="responsive">
                            <span class="star" data-rating="1">‚≠ê</span>
                            <span class="star" data-rating="2">‚≠ê</span>
                            <span class="star" data-rating="3">‚≠ê</span>
                            <span class="star" data-rating="4">‚≠ê</span>
                            <span class="star" data-rating="5">‚≠ê</span>
                        </div>
                    </div>

                    <div class="feedback-question">
                        <label class="feedback-label">Do you feel the care home is caring towards people?</label>
                        <div class="star-rating" data-question="caring">
                            <span class="star" data-rating="1">‚≠ê</span>
                            <span class="star" data-rating="2">‚≠ê</span>
                            <span class="star" data-rating="3">‚≠ê</span>
                            <span class="star" data-rating="4">‚≠ê</span>
                            <span class="star" data-rating="5">‚≠ê</span>
                        </div>
                    </div>

                    <div class="feedback-question">
                        <label class="feedback-label">Do you feel the care home is well-led?</label>
                        <div class="star-rating" data-question="leadership">
                            <span class="star" data-rating="1">‚≠ê</span>
                            <span class="star" data-rating="2">‚≠ê</span>
                            <span class="star" data-rating="3">‚≠ê</span>
                            <span class="star" data-rating="4">‚≠ê</span>
                            <span class="star" data-rating="5">‚≠ê</span>
                        </div>
                    </div>

                    <div class="feedback-question">
                        <label class="feedback-label">Do you feel the care provided is effective?</label>
                        <div class="star-rating" data-question="effectiveness">
                            <span class="star" data-rating="1">‚≠ê</span>
                            <span class="star" data-rating="2">‚≠ê</span>
                            <span class="star" data-rating="3">‚≠ê</span>
                            <span class="star" data-rating="4">‚≠ê</span>
                            <span class="star" data-rating="5">‚≠ê</span>
                        </div>
                    </div>

                    <div class="feedback-question">
                        <label class="feedback-label">Do you have any other feedback about your visit?</label>
                        <textarea id="additionalFeedback" placeholder="Please share any additional comments..." 
                                rows="4" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: Arial, sans-serif; font-size: 14px; resize: vertical; margin-top: 8px;"></textarea>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="button" class="btn btn-success" onclick="doSubmitFeedback()">‚úÖ Submit Feedback</button>
                    </div>
                </form>
            </div>

            <!-- Staff Authentication Page -->
            <div id="staffAuthPage" class="page">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Staff Authentication</h2>
                <div class="alert alert-info">Please enter your staff password to manage client profiles</div>
                <div class="form-group">
                    <label for="staffPassword">Password:</label>
                    <input type="password" id="staffPassword" placeholder="Enter staff password" onkeypress="if(event.key==='Enter') doStaffLogin()">
                </div>
                <button class="btn btn-primary" onclick="doStaffLogin()">üîê Verify Staff Access</button>
                <button class="btn btn-secondary" onclick="doGoBack()">‚Üê Back</button>
                <div id="staffLoginError" style="display: none; color: #e74c3c; text-align: center; margin-top: 15px; font-size: 14px;"></div>
            </div>

            <!-- Client Management Page -->
            <div id="clientManagementPage" class="page">
                <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 10px;">
                    <div class="settings-icon" onclick="doGoBack()" style="position: static; margin: 0; background: #6c757d; color: white; border: 2px solid #5a6268; border-radius: 12px; width: 100px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: bold;">‚Üê Back</div>
                    <div class="settings-icon" onclick="loadClientProfiles()" style="position: static; margin: 0; background: #17a2b8; color: white; border: 2px solid #138496; border-radius: 12px; width: 100px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: bold;">üîÑ Refresh</div>
                </div>
                
                <h2 style="text-align: center; margin-bottom: 30px; margin-top: 60px; color: #333;">Client Management</h2>
                <div class="alert alert-info" id="locationInfo">Managing clients for: <span id="currentLocationSpan"></span></div>
                
                <div class="client-management">
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showAddClientForm()">‚ûï Add New Client</button>
                    </div>
                    
                    <div id="clientList" class="client-list">
                        <!-- Client cards will be populated here -->
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="btn btn-primary" onclick="finishClientManagement()">‚úÖ Done</button>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Client Form -->
            <div id="addClientPage" class="page">
                <div style="position: absolute; top: 15px; right: 15px;">
                    <div class="settings-icon" onclick="cancelAddClient()" style="position: static; margin: 0; background: #6c757d; color: white; border: 2px solid #5a6268; border-radius: 12px; width: 100px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: bold;">‚Üê Back</div>
                </div>
                
                <h2 style="text-align: center; margin-bottom: 30px; margin-top: 60px; color: #333;" id="clientFormTitle">Add New Client</h2>
                
                <div class="form-group">
                    <div class="photo-upload">
                        <img id="photoPreview" class="photo-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Ccircle cx='40' cy='40' r='38' fill='%23f8f9fa' stroke='%23e0e0e0' stroke-width='2'/%3E%3Ctext x='40' y='50' text-anchor='middle' font-size='24' fill='%23666'%3Eüë§%3C/text%3E%3C/svg%3E" alt="Client Photo">
                        <div class="upload-btn">
                            <label for="clientPhoto" class="btn btn-secondary">üì∑ Choose Photo</label>
                            <input type="file" id="clientPhoto" accept="image/*" onchange="previewPhoto(event)">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="clientFirstName">First Name: <span class="required">*</span></label>
                    <input type="text" id="clientFirstName" required>
                </div>
                
                <div class="form-group">
                    <label for="clientLastName">Last Name: <span class="required">*</span></label>
                    <input type="text" id="clientLastName" required>
                </div>
                
                <div class="form-group">
                    <label for="clientLocation">Location: <span class="required">*</span></label>
                    <select id="clientLocation" required>
                        <option value="">-- Select Location --</option>
                        <option value="The Royal">The Royal</option>
                        <option value="The Crown">The Crown</option>
                        <option value="Seabreeze">Seabreeze</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-success" onclick="saveClientProfile()">üíæ Save Client</button>
                    <button class="btn btn-secondary" onclick="cancelAddClient()">‚ùå Cancel</button>
                </div>
            </div>

            <!-- Staff Management Page -->
            <div id="staffManagementPage" class="page">
                <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 10px;">
                    <div class="settings-icon" onclick="doGoBack()" style="position: static; margin: 0; background: #6c757d; color: white; border: 2px solid #5a6268; border-radius: 12px; width: 100px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: bold;">‚Üê Back</div>
                    <div class="settings-icon" onclick="loadStaffProfiles()" style="position: static; margin: 0; background: #17a2b8; color: white; border: 2px solid #138496; border-radius: 12px; width: 100px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: bold;">üîÑ Refresh</div>
                </div>
                
                <h2 style="text-align: center; margin-bottom: 30px; margin-top: 60px; color: #333;">Staff Management</h2>
                <div class="alert alert-info" id="staffLocationInfo">Managing staff for: <span id="currentStaffLocationSpan"></span></div>
                
                <div class="client-management">
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="showAddStaffForm()">‚ûï Add New Staff Member</button>
                    </div>
                    
                    <div id="staffList" class="client-list">
                        <!-- Staff cards will be populated here -->
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="btn btn-primary" onclick="finishStaffManagement()">‚úÖ Done</button>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Staff Form -->
            <div id="addStaffPage" class="page">
                <div style="position: absolute; top: 15px; right: 15px;">
                    <div class="settings-icon" onclick="cancelAddStaff()" style="position: static; margin: 0; background: #6c757d; color: white; border: 2px solid #5a6268; border-radius: 12px; width: 100px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: bold;">‚Üê Back</div>
                </div>
                
                <h2 style="text-align: center; margin-bottom: 30px; margin-top: 60px; color: #333;" id="staffFormTitle">Add New Staff Member</h2>
                
                <div class="form-group">
                    <div class="photo-upload">
                        <img id="staffPhotoPreview" class="photo-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Ccircle cx='40' cy='40' r='38' fill='%23f8f9fa' stroke='%23e0e0e0' stroke-width='2'/%3E%3Ctext x='40' y='50' text-anchor='middle' font-size='24' fill='%23666'%3Eüë§%3C/text%3E%3C/svg%3E" alt="Staff Photo">
                        <div class="upload-btn">
                            <label for="staffPhoto" class="btn btn-secondary">üì∑ Choose Photo</label>
                            <input type="file" id="staffPhoto" accept="image/*" onchange="previewStaffPhoto(event)">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="staffFirstName">First Name: <span class="required">*</span></label>
                    <input type="text" id="staffFirstName" required>
                </div>
                
                <div class="form-group">
                    <label for="staffLastName">Last Name: <span class="required">*</span></label>
                    <input type="text" id="staffLastName" required>
                </div>
                
                <div class="form-group">
                    <label for="staffLocationSelect">Location: <span class="required">*</span></label>
                    <select id="staffLocationSelect" required>
                        <option value="">-- Select Location --</option>
                        <option value="The Royal">The Royal</option>
                        <option value="The Crown">The Crown</option>
                        <option value="Seabreeze">Seabreeze</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-success" onclick="saveStaffProfile()">üíæ Save Staff Member</button>
                    <button class="btn btn-secondary" onclick="cancelAddStaff()">‚ùå Cancel</button>
                </div>
            </div>

            <div id="successPage" class="page">
                <!-- Personal Message Box - Large and Eye-catching -->
                <div class="alert" style="background: linear-gradient(135deg, #d4f6d4 0%, #c8e6c9 100%); color: #2e7d32; border: 2px solid #a5d6a7; padding: 25px; margin-bottom: 15px; font-size: 18px; font-weight: bold; text-align: center; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div id="successMsg" style="font-size: 20px; margin-bottom: 5px;"></div>
                </div>
                
                <!-- System Message Box - Smaller and Subtle -->
                <div class="alert" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; padding: 12px; font-size: 13px; text-align: center; border-radius: 8px;">
                    <div id="successDetails"></div>
                    <div id="countdown" class="countdown"></div>
                </div>
            </div>
        </div>
    </div>

   <script>
        // Disable console logs in production
        (function() {
            if (window.location.protocol === 'https:' || window.location.hostname !== 'localhost') {
                console.log = function() {};
                console.warn = function() {};
                console.error = function() {};
                console.info = function() {};
                console.debug = function() {};
            }
        })();

        // Global variables - MOVED TO TOP LEVEL
        let APP = {
            company: '',
            locations: [],
            currentBusiness: '',
            currentUserType: '',
            adminClicks: 0
        };
        let currentDepartingVisitor = null;
        let editingClientId = null;
        let editingStaffId = null;
        let clientProfiles = [];
        let staffProfiles = [];

        // Enhanced performance optimization with caching
        let dataCache = {
            clients: new Map(), // locationName -> {data: [], timestamp: number}
            staff: new Map(),
            cacheTimeout: 5 * 60 * 1000 // 5 minutes cache
        };

        // Enhanced error handling
        function handleApiError(error, operation = 'API operation') {
            console.error(`‚ùå ${operation} failed:`, error);
            
            // Check if it's a network error
            if (!navigator.onLine) {
                showUserFriendlyError('No internet connection. Please check your network and try again.');
                return;
            }
            
            // Check if it's a server error
            if (error.message && error.message.includes('HTTP 5')) {
                showUserFriendlyError('Server is temporarily unavailable. Please try again in a few moments.');
                return;
            }
            
            // Generic error
            showUserFriendlyError('Something went wrong. Please try again or contact support if the problem persists.');
        }

        function showUserFriendlyError(message) {
            // Create or update error notification
            let errorDiv = document.getElementById('globalError');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'globalError';
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #ff5252;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 400px;
                    text-align: center;
                    font-weight: bold;
                `;
                document.body.appendChild(errorDiv);
            }
            
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (errorDiv && errorDiv.parentNode) {
                    errorDiv.style.display = 'none';
                }
            }, 5000);
        }

        // Supabase configuration
        const VISITOR_CONFIG = {
            supabaseUrl: 'https://obyzwhqaqyiqpeoefjgw.supabase.co',
            supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ieXp3aHFhcXlpcXBlb2Vmamd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDY0MDAsImV4cCI6MjA2NzU4MjQwMH0.NaePwt-LGqNp4vc8TTcv3IyzFkamZtiHmvDLpDcliAc'
        };

        // Initialize Supabase client for legacy code compatibility
        const supabase = {
            from: function(table) {
                return {
                    select: function(columns) {
                        return {
                            eq: function(column, value) {
                                // Convert to standard fetch call
                                return fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/${table}?${column}=eq.${encodeURIComponent(value)}&select=${columns}`, {
                                    method: 'GET',
                                    headers: {
                                        'apikey': VISITOR_CONFIG.supabaseAnonKey,
                                        'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                                        'Content-Type': 'application/json'
                                    }
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => ({
                                    data: data,
                                    error: null
                                }))
                                .catch(error => ({
                                    data: null,
                                    error: error
                                }));
                            }
                        };
                    }
                };
            }
        };

        // Enhanced login function with iPad compatibility
        function handleLoginSubmit(event) {
            console.log('iPad-compatible login handler called');
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Small delay to ensure iPad processes the form submission properly
            setTimeout(() => {
                doLogin(event);
            }, 10);
            
            return false; // Prevent default form submission
        }
        
        // LOGIN FUNCTION - ENHANCED FOR IPAD COMPATIBILITY
        function doLogin(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('Login function called');
            
            // Get form elements with additional safety checks for iPad
            const emailField = document.getElementById('emailAddress');
            const passwordField = document.getElementById('password');
            
            if (!emailField || !passwordField) {
                console.error('Login form fields not found');
                showError('Login form error. Please refresh the page.');
                return false;
            }
            
            const email = emailField.value.trim().toLowerCase();
            const password = passwordField.value.trim();
            
            console.log('Email length:', email.length, 'Password length:', password.length);
            
            if (!email || !password) {
                showError('Please enter both email and password.');
                return false;
            }
            
            // Basic email validation
            if (!email.includes('@') || !email.includes('.')) {
                showError('Please enter a valid email address.');
                return false;
            }
            
            if (email === 'office@alexdavis.co.uk' && password === 'office927') {
                console.log('Login successful!');
                APP.company = 'Alex Davis Care Group';
                APP.locations = ['The Royal', 'The Crown', 'Seabreeze'];
                
                // Save login state to localStorage with expiration
                const loginData = {
                    isAuthenticated: true,
                    company: APP.company,
                    locations: APP.locations,
                    loginTime: Date.now(),
                    expiresIn: 7 * 24 * 60 * 60 * 1000 // 7 days in milliseconds
                };
                localStorage.setItem('hellohubAuth', JSON.stringify(loginData));
                
                // Clear form fields
                emailField.value = '';
                passwordField.value = '';
                hideError();
                
                // Start preloading data immediately after login
                preloadAllLocationData();
                
                setupBusinessDropdown();
                showPage('businessSelect');
                saveSessionState();
                
                return true;
            } else {
                console.log('Login failed - incorrect credentials');
                showError('Invalid email or password.');
                return false;
            }
        }

        // ALL OTHER FUNCTIONS FOLLOW
        function showLoadingOptions(divId) {
            const div = document.getElementById(divId);
            if (div) {
                div.innerHTML = '<div style="padding: 10px; text-align: center; color: #555;">Loading...</div>';
            }
        }

        let clientProfilesLoaded = false;
        let staffProfilesLoaded = false;

        // Check if user is already logged in from previous session
        function checkAutoLogin() {
            const savedAuth = localStorage.getItem('hellohubAuth');
            
            if (!savedAuth) {
                console.log('No saved login found');
                return false;
            }
            
            try {
                const authData = JSON.parse(savedAuth);
                const now = Date.now();
                const timeElapsed = now - authData.loginTime;
                
                // Check if login has expired (7 days)
                if (timeElapsed > authData.expiresIn) {
                    console.log('Saved login has expired');
                    localStorage.removeItem('hellohubAuth');
                    return false;
                }
                
                // Valid saved login found
                console.log('‚úÖ Valid saved login found, auto-logging in...');
                
                // Restore login state
                APP.company = authData.company;
                APP.locations = authData.locations;
                
                // Show logged-in state immediately
                setupBusinessDropdown();
                updateHeader();
                
                // Start preloading data
                preloadAllLocationData();
                
                return true;
                
            } catch (error) {
                console.log('Error reading saved login:', error);
                localStorage.removeItem('hellohubAuth');
                return false;
            }
        }

        // Smart cache-aware loading
        function loadClientProfilesForLocation(location) {
            // Check cache first
            const cached = dataCache.clients.get(location);
            const now = Date.now();
            
            if (cached && (now - cached.timestamp) < dataCache.cacheTimeout) {
                console.log(`üìã Using cached client data for ${location}`);
                return Promise.resolve(cached.data);
            }
            
            console.log(`üåê Fetching fresh client data for ${location}`);
            
            return fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/client_profiles?location=eq.${encodeURIComponent(location)}&select=*`, {
                method: 'GET',
                headers: {
                    'apikey': VISITOR_CONFIG.supabaseAnonKey,
                    'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                // Cache the data
                dataCache.clients.set(location, {
                    data: data || [],
                    timestamp: now
                });
                
                console.log(`‚úÖ Cached ${data.length} clients for ${location}`);
                return data || [];
            })
            .catch(error => {
                handleApiError(error, `Loading clients for ${location}`);
                return [];
            });
        }

        function loadStaffProfilesForLocation(location) {
            const cached = dataCache.staff.get(location);
            const now = Date.now();
            
            if (cached && (now - cached.timestamp) < dataCache.cacheTimeout) {
                console.log(`üë• Using cached staff data for ${location}`);
                return Promise.resolve(cached.data);
            }
            
            console.log(`üåê Fetching fresh staff data for ${location}`);
            
            return fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/staff_profiles?location=eq.${encodeURIComponent(location)}&select=*`, {
                method: 'GET',
                headers: {
                    'apikey': VISITOR_CONFIG.supabaseAnonKey,
                    'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                dataCache.staff.set(location, {
                    data: data || [],
                    timestamp: now
                });
                
                console.log(`‚úÖ Cached ${data.length} staff for ${location}`);
                return data || [];
            })
            .catch(error => {
                handleApiError(error, `Loading staff for ${location}`);
                return [];
            });
        }

        // Preload all location data when user logs in
        function preloadAllLocationData() {
            console.log('üöÄ Preloading all location data...');
            
            const locations = ['The Royal', 'The Crown', 'Seabreeze'];
            const startTime = Date.now();
            
            // Load all data concurrently
            const allPromises = locations.flatMap(location => [
                loadClientProfilesForLocation(location),
                loadStaffProfilesForLocation(location)
            ]);
            
            Promise.allSettled(allPromises).then(results => {
                const loadTime = Date.now() - startTime;
                console.log(`‚úÖ Preloading completed in ${loadTime}ms`);
                
                // Log cache status
                console.log('Cache status:', {
                    clients: Array.from(dataCache.clients.keys()),
                    staff: Array.from(dataCache.staff.keys())
                });
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                console.error('Login error:', message);
                
                // Add iPad-specific debugging information
                const debugInfo = getIPadDebugInfo();
                console.log('iPad Debug Info:', debugInfo);
            }
        }

        function hideError() {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
        
        // iPad debugging function to help troubleshoot issues
        function getIPadDebugInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                isIPad: /iPad|Macintosh/.test(navigator.userAgent) && 'ontouchend' in document,
                isSafari: /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor),
                screenSize: `${window.screen.width}x${window.screen.height}`,
                viewportSize: `${window.innerWidth}x${window.innerHeight}`,
                devicePixelRatio: window.devicePixelRatio,
                orientation: window.orientation,
                localStorage: typeof(Storage) !== "undefined",
                touchSupport: 'ontouchstart' in window,
                formElements: {
                    emailField: !!document.getElementById('emailAddress'),
                    passwordField: !!document.getElementById('password'),
                    loginForm: !!document.getElementById('loginForm'),
                    loginButton: !!document.getElementById('loginButton')
                }
            };
        }
        
        // Enhanced error reporting for iPad issues
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e);
            console.log('iPad Debug Info at time of error:', getIPadDebugInfo());
        });
        
        // Log iPad detection on page load
        window.addEventListener('load', function() {
            const debugInfo = getIPadDebugInfo();
            console.log('=== iPad Compatibility Check ===');
            console.log('Device detected as iPad:', debugInfo.isIPad);
            console.log('Safari browser:', debugInfo.isSafari);
            console.log('Touch support:', debugInfo.touchSupport);
            console.log('All login form elements present:', 
                debugInfo.formElements.emailField && 
                debugInfo.formElements.passwordField && 
                debugInfo.formElements.loginForm && 
                debugInfo.formElements.loginButton
            );
            console.log('Full debug info:', debugInfo);
        });
        
        // iPad troubleshooting function
        function showIPadDiagnostics() {
            const debugInfo = getIPadDebugInfo();
            
            let diagnosticMessage = "iPad Diagnostic Information:\\n\\n";
            diagnosticMessage += `Device: ${debugInfo.isIPad ? 'iPad Detected' : 'Not iPad'}\\n`;
            diagnosticMessage += `Browser: ${debugInfo.isSafari ? 'Safari' : 'Other'}\\n`;
            diagnosticMessage += `Touch Support: ${debugInfo.touchSupport ? 'Yes' : 'No'}\\n`;
            diagnosticMessage += `Screen: ${debugInfo.screenSize}\\n`;
            diagnosticMessage += `Viewport: ${debugInfo.viewportSize}\\n`;
            
            const formElementsWorking = debugInfo.formElements.emailField && 
                                        debugInfo.formElements.passwordField && 
                                        debugInfo.formElements.loginForm && 
                                        debugInfo.formElements.loginButton;
            
            diagnosticMessage += `Form Elements: ${formElementsWorking ? 'All Present' : 'Missing Elements'}\\n\\n`;
            
            if (!formElementsWorking) {
                diagnosticMessage += "ISSUE: Form elements missing. Try refreshing the page.\\n\\n";
            }
            
            diagnosticMessage += "Common Solutions:\\n";
            diagnosticMessage += "1. Clear Safari cache and cookies\\n";
            diagnosticMessage += "2. Close and reopen Safari\\n";  
            diagnosticMessage += "3. Restart iPad\\n";
            diagnosticMessage += "4. Update Safari/iPad OS\\n";
            diagnosticMessage += "5. Try typing credentials manually (no copy/paste)\\n\\n";
            
            diagnosticMessage += "If login still fails, check console logs or contact support.";
            
            alert(diagnosticMessage);
            
            // Also log to console for technical users
            console.log('=== iPad Diagnostic Report ===');
            console.log(debugInfo);
        }

        function setupBusinessDropdown() {
            const dropdown = document.getElementById('businessDropdown');
            dropdown.innerHTML = '<option value="">-- Select Location --</option>';
            
            APP.locations.forEach((loc, i) => {
                const opt = document.createElement('option');
                opt.value = `loc-${i}`;
                opt.textContent = loc;
                dropdown.appendChild(opt);
            });
        }

        function doSelectBusiness() {
            APP.currentBusiness = document.getElementById('businessDropdown').value;
            if (APP.currentBusiness) {
                updateHeader();
                fastSwitchLocation(); // Use fast switching instead
                showPage('userTypeSelect');
                saveSessionState();
            }
        }

        // Fast location switching with cached data
        function fastSwitchLocation() {
            const currentLocation = getLocationName();
            
            // Get data from cache immediately
            const cachedClients = dataCache.clients.get(currentLocation);
            const cachedStaff = dataCache.staff.get(currentLocation);
            
            if (cachedClients) {
                clientProfiles = cachedClients.data;
                console.log(`‚ö° Instantly loaded ${clientProfiles.length} clients from cache`);
            }
            
            if (cachedStaff) {
                staffProfiles = cachedStaff.data;
                console.log(`‚ö° Instantly loaded ${staffProfiles.length} staff from cache`);
            }
            
            // Refresh cache in background if needed
            const now = Date.now();
            const promises = [];
            
            if (!cachedClients || (now - cachedClients.timestamp) > dataCache.cacheTimeout) {
                promises.push(loadClientProfilesForLocation(currentLocation));
            }
            
            if (!cachedStaff || (now - cachedStaff.timestamp) > dataCache.cacheTimeout) {
                promises.push(loadStaffProfilesForLocation(currentLocation));
            }
            
            if (promises.length > 0) {
                Promise.all(promises).then(() => {
                    // Update arrays with fresh data
                    const freshClients = dataCache.clients.get(currentLocation);
                    const freshStaff = dataCache.staff.get(currentLocation);
                    
                    if (freshClients) clientProfiles = freshClients.data;
                    if (freshStaff) staffProfiles = freshStaff.data;
                    
                    console.log('üîÑ Background refresh completed');
                });
            }
        }

        function updateHeader() {
            const logo = document.getElementById('headerLogo');
            const locationDiv = document.getElementById('locationName');
            
            if (APP.company === 'Alex Davis Care Group') {
                // Show company branding when logged in
                document.getElementById('headerTitle').textContent = `Alex Davis Care Group`;
                document.getElementById('headerSubtitle').textContent = ``;
                
                // Show and setup logo with logout functionality
                logo.style.display = 'block';
                logo.onmousedown = startLogoutTimer;
                logo.onmouseup = cancelLogoutTimer;
                logo.onmouseleave = cancelLogoutTimer;
                logo.ontouchstart = startLogoutTimer;
                logo.ontouchend = cancelLogoutTimer;
                
                document.body.classList.add('alex-davis-logged-in');
                
                // Only show location name and background if location is selected
                if (APP.currentBusiness) {
                    const locationName = getLocationName();
                    if (locationName) {
                        locationDiv.textContent = locationName;
                        locationDiv.style.display = 'block';
                        
                        // Add location-specific background class
                        const location = locationName.toLowerCase().replace(/\s+/g, '-');
                        document.body.classList.add(`location-${location}`);
                    }
                } else {
                    // On location selection page - no location name yet
                    locationDiv.style.display = 'none';
                    locationDiv.textContent = ''; // Clear any previous location text
                    document.body.classList.remove('location-the-royal', 'location-the-crown', 'location-seabreeze');
                }
            } else {
                // Default state - not logged in
                document.body.classList.remove('alex-davis-logged-in');
                document.body.classList.remove('location-the-royal', 'location-the-crown', 'location-seabreeze');
                logo.style.display = 'none';
                locationDiv.style.display = 'none';
                locationDiv.textContent = ''; // Clear location text when not logged in
            }
        }

        function getLocationName() {
            const idx = parseInt(APP.currentBusiness.replace('loc-', ''));
            return APP.locations[idx] || '';
        }

        function doSelectUserType(type) {
            APP.currentUserType = type;
            document.querySelectorAll('.user-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.user-type-btn').classList.add('active');
            saveSessionState(); // Add session saving here
        }

        function doShowAction(action) {
            if (!APP.currentUserType) {
                alert('Please select your user type first.');
                return;
            }
            
            if (action === 'arriving') {
                buildArrivalForm();
                showPage('arrivingPage');
                saveSessionState(); // Save state when going to arriving page
            } else {
                buildDepartureForm();
                showPage('leavingPage');
                saveSessionState(); // Save state when going to leaving page
            }
        }

        // Add all the remaining functions here...
        function buildArrivalForm() {
            const form = document.getElementById('arrivalForm');
            let fields = '';
            
            if (APP.currentUserType === 'visitor') {
                fields = `
                    <div class="form-group">
                        <label>First Name: <span class="required">*</span></label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label>Surname: <span class="required">*</span></label>
                        <input type="text" id="surname" required>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="email" placeholder="example@email.com">
                    </div>
                    <div class="form-group">
                        <label>Mobile:</label>
                        <input type="tel" id="mobile" placeholder="04XX XXX XXX">
                    </div>
                `;
            } else if (APP.currentUserType === 'client') {
                // Check if current location supports client management
                const currentLocation = getLocationName();
                if (currentLocation === 'The Royal' || currentLocation === 'The Crown' || currentLocation === 'Seabreeze') {
                    fields = `
                        <div class="form-group">
                            <label>Select Client: <span class="required">*</span></label>
                            <div style="display: flex; gap: 10px; align-items: flex-start;">
                                <div class="client-dropdown" style="flex: 1;">
                                    <div class="client-select" id="clientSelect" onclick="toggleClientOptions()">
                                        Choose a client...
                                    </div>
                                    <div class="client-options" id="clientOptions">
                                        <!-- Client options will be populated here -->
                                    </div>
                                </div>
                                <div class="settings-icon" onclick="showClientSettings()" style="position: static; margin-top: 0; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: all 0.3s ease;">‚öôÔ∏è</div>
                            </div>
                            <input type="hidden" id="selectedClientId">
                        </div>
                    `;
                } else {
                    fields = `
                        <div class="form-group">
                            <label>First Name: <span class="required">*</span></label>
                            <input type="text" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label>Surname: <span class="required">*</span></label>
                            <input type="text" id="surname" required>
                        </div>
                        <div class="alert alert-info">
                            Client management is available for The Royal, The Crown, and Seabreeze locations.
                        </div>
                    `;
                }
            } else {
                // For staff at The Royal, The Crown, and Seabreeze, show dropdown with photos
                if (APP.currentUserType === 'staff' && (getLocationName() === 'The Royal' || getLocationName() === 'The Crown' || getLocationName() === 'Seabreeze')) {
                    fields = `
                        <div class="form-group">
                            <label>Select Staff Member: <span class="required">*</span></label>
                            <div style="display: flex; gap: 10px; align-items: flex-start;">
                                <div class="client-dropdown" style="flex: 1;">
                                    <div class="client-select" id="staffSelect" onclick="toggleStaffOptions()">
                                        Choose a staff member...
                                    </div>
                                    <div class="client-options" id="staffOptions">
                                        <!-- Staff options will be populated here -->
                                    </div>
                                </div>
                                <div class="settings-icon" onclick="showStaffSettings()" style="position: static; margin-top: 0; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: all 0.3s ease;">‚öôÔ∏è</div>
                            </div>
                            <input type="hidden" id="selectedStaffId">
                        </div>
                    `;
                } else {
                    // Traditional text input for other locations
                    fields = `
                        <div class="form-group">
                            <label>First Name: <span class="required">*</span></label>
                            <input type="text" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label>Surname: <span class="required">*</span></label>
                            <input type="text" id="surname" required>
                        </div>
                    `;
                }
            }
            
            form.innerHTML = fields + `
                <button class="btn btn-success" onclick="doRecordArrival()">üíæ Record Arrival</button>
                <button class="btn btn-secondary" onclick="doGoBack()">‚Üê Back</button>
            `;
            
            // Populate client options if it's a client form
            if (APP.currentUserType === 'client') {
                populateClientOptions();
            }
            
            // Populate staff options if it's a staff form at any location with staff management
            if (APP.currentUserType === 'staff' && (getLocationName() === 'The Royal' || getLocationName() === 'The Crown' || getLocationName() === 'Seabreeze')) {
                populateStaffOptions();
            }
        }

        // Continue with the rest of the functions...
        function buildDepartureForm() {
            const currentLocation = getLocationName();
            
            // Check if this is a client departure at The Royal, The Crown, or Seabreeze
            if (APP.currentUserType === 'client' && (currentLocation === 'The Royal' || currentLocation === 'The Crown' || currentLocation === 'Seabreeze')) {
                document.getElementById('leavingPage').innerHTML = `
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Leaving</h2>
                    
                    <div class="form-group">
                        <label>Select Client: <span class="required">*</span></label>
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <div class="client-dropdown" style="flex: 1;">
                                <div class="client-select" id="departureClientSelect" onclick="toggleDepartureClientOptions()">
                                    Choose a client...
                                </div>
                                <div class="client-options" id="departureClientOptions">
                                    <!-- Client options will be populated here -->
                                </div>
                            </div>
                            <div class="settings-icon" onclick="showClientSettings()" style="position: static; margin-top: 0; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: all 0.3s ease;">‚öôÔ∏è</div>
                        </div>
                        <input type="hidden" id="selectedDepartureClientId">
                    </div>
                    
                    <button class="btn btn-warning" onclick="doRecordDeparture()">Record Departure</button>
                    <button class="btn btn-secondary" onclick="doGoBack()">‚Üê Back</button>
                `;
                
                // Populate departure client options
                populateDepartureClientOptions();
            } else {
                // For staff departure at The Royal, The Crown, and Seabreeze, show dropdown
                if (APP.currentUserType === 'staff' && (currentLocation === 'The Royal' || currentLocation === 'The Crown' || currentLocation === 'Seabreeze')) {
                    document.getElementById('leavingPage').innerHTML = `
                        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Leaving</h2>
                        
                        <div class="form-group">
                            <label>Select Staff Member: <span class="required">*</span></label>
                            <div style="display: flex; gap: 10px; align-items: flex-start;">
                                <div class="client-dropdown" style="flex: 1;">
                                    <div class="client-select" id="departureStaffSelect" onclick="toggleDepartureStaffOptions()">
                                        Choose a staff member...
                                    </div>
                                    <div class="client-options" id="departureStaffOptions">
                                        <!-- Staff options will be populated here -->
                                    </div>
                                </div>
                                <div class="settings-icon" onclick="showStaffSettings()" style="position: static; margin-top: 0; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: all 0.3s ease;">‚öôÔ∏è</div>
                            </div>
                            <input type="hidden" id="selectedDepartureStaffId">
                        </div>
                        
                        <button class="btn btn-warning" onclick="doRecordDeparture()">Record Departure</button>
                        <button class="btn btn-secondary" onclick="doGoBack()">‚Üê Back</button>
                    `;
                    
                    // Populate departure staff options
                    populateDepartureStaffOptions();
                } else {
                    // Original departure form for other user types or locations
                    document.getElementById('leavingPage').innerHTML = `
                        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Leaving</h2>
                        <div class="form-group">
                            <label for="leaveFirst">First Name: <span class="required">*</span></label>
                            <input type="text" id="leaveFirst" required autocomplete="off" oninput="showNameSuggestions()" onblur="hideNameSuggestions()" onkeydown="handleSuggestionKeyboard(event)">
                            <div id="nameSuggestions" style="display: none; position: absolute; background: white; border: 1px solid #ccc; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                        </div>
                        <div class="form-group">
                            <label for="leaveLast">Surname: <span class="required">*</span></label>
                            <input type="text" id="leaveLast" required autocomplete="off">
                        </div>
                        <button class="btn btn-warning" onclick="doRecordDeparture()">Record Departure</button>
                        <button class="btn btn-secondary" onclick="doGoBack()">‚Üê Back</button>
                    `;
                }
            }
        }

        // Add all the remaining critical functions
        function populateClientOptions() {
            const optionsDiv = document.getElementById('clientOptions');
            if (!optionsDiv) return;

            // Ensure client profiles are loaded before populating
            if (clientProfiles.length === 0) {
                loadClientProfiles().then(() => {
                    populateClientOptionsInternal();
                });
            } else {
                populateClientOptionsInternal();
            }
        }

        function populateClientOptionsInternal() {
            const optionsDiv = document.getElementById('clientOptions');
            if (!optionsDiv) return;

            const currentLocation = getLocationName();
            const locationClients = (clientProfiles.filter(client => (client.location || '').trim().toLowerCase() === currentLocation.trim().toLowerCase()));

            if (locationClients.length === 0) {
                optionsDiv.innerHTML = '<div class="client-option" style="color: #666; font-style: italic;">No clients registered for this location</div>';
                return;
            }

            // Sort clients alphabetically by first name
            locationClients.sort((a, b) => a.first_name.localeCompare(b.first_name));

            optionsDiv.innerHTML = '';
            locationClients.forEach(client => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'client-option';
                optionDiv.onclick = () => selectClient(client);
                
                optionDiv.innerHTML = `
                    <img class="client-photo" src="${client.photo_url || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'18\' fill=\'%23f8f9fa\' stroke=\'%23e0e0e0\' stroke-width=\'2\'/%3E%3Ctext x=\'20\' y=\'26\' text-anchor=\'middle\' font-size=\'12\' fill=\'%23666\'%3Eüë§%3C/text%3E%3C/svg%3E'}" alt="${client.first_name} ${client.last_name}">
                    <span class="client-name">${client.first_name} ${client.last_name}</span>
                `;
                
                optionsDiv.appendChild(optionDiv);
            });
        }

        function toggleClientOptions() {
            const optionsDiv = document.getElementById('clientOptions');
            if (optionsDiv.style.display === 'none' || !optionsDiv.style.display) {
                optionsDiv.style.display = 'block';
                ultraFastPopulateClients(); // Ultra-fast population
            } else {
                optionsDiv.style.display = 'none';
            }
        }

        function selectClient(client) {
            document.getElementById('clientSelect').textContent = `${client.first_name} ${client.last_name}`;
            document.getElementById('selectedClientId').value = client.id;
            document.getElementById('clientOptions').style.display = 'none';
        }

        function ultraFastPopulateClients() {
            const optionsDiv = document.getElementById('clientOptions');
            if (!optionsDiv) return;

            const currentLocation = getLocationName();
            
            // Get from cache instantly
            const cachedData = dataCache.clients.get(currentLocation);
            if (cachedData) {
                const locationClients = cachedData.data.filter(client => 
                    (client.location || '').trim().toLowerCase() === currentLocation.trim().toLowerCase()
                );
                
                renderClientOptions(optionsDiv, locationClients, currentLocation);
                return;
            }
            
            // Show loading while fetching
            optionsDiv.innerHTML = '<div class="client-option" style="padding: 15px; text-align: center; color: #666;">‚ö° Loading...</div>';
            
            loadClientProfilesForLocation(currentLocation).then(data => {
                clientProfiles = data;
                const locationClients = data.filter(client => 
                    (client.location || '').trim().toLowerCase() === currentLocation.trim().toLowerCase()
                );
                renderClientOptions(optionsDiv, locationClients, currentLocation);
            });
        }

        function renderClientOptions(optionsDiv, clients, location) {
            if (clients.length === 0) {
                optionsDiv.innerHTML = `<div class="client-option" style="color: #666; font-style: italic; padding: 15px; text-align: center;">No clients for ${location}</div>`;
                return;
            }

            clients.sort((a, b) => a.first_name.localeCompare(b.first_name));

            const html = clients.map(client => `
                <div class="client-option" onclick="selectClient(${JSON.stringify(client).replace(/"/g, '&quot;')})">
                    <img class="client-photo" src="${client.photo_url || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'18\' fill=\'%23f8f9fa\' stroke=\'%23e0e0e0\' stroke-width=\'2\'/%3E%3Ctext x=\'20\' y=\'26\' text-anchor=\'middle\' font-size=\'12\' fill=\'%23666\'%3Eüë§%3C/text%3E%3C/svg%3E'}" alt="${client.first_name} ${client.last_name}">
                    <span class="client-name">${client.first_name} ${client.last_name}</span>
                </div>
            `).join('');

            optionsDiv.innerHTML = html;
        }

        // Add all the other critical functions
        function doRecordArrival() {
            let firstName, surname;
            
            if (APP.currentUserType === 'client') {
                const currentLocation = getLocationName();
                if (currentLocation === 'The Royal' || currentLocation === 'The Crown' || currentLocation === 'Seabreeze') {
                    const selectedClientId = document.getElementById('selectedClientId').value;
                    if (!selectedClientId) {
                        alert('Please select a client from the dropdown.');
                        return;
                    }
                    
                    const selectedClient = clientProfiles.find(c => c.id == selectedClientId);
                    if (!selectedClient) {
                        alert('Selected client not found. Please try again.');
                        return;
                    }
                    
                    firstName = selectedClient.first_name;
                    surname = selectedClient.last_name;
                } else {
                    firstName = document.getElementById('firstName').value.trim();
                    surname = document.getElementById('surname').value.trim();
                    
                    if (!firstName || !surname) {
                        alert('Please enter both first name and surname.');
                        return;
                    }
                }
            } else if (APP.currentUserType === 'staff') {
                const currentLocation = getLocationName();
                if (currentLocation === 'The Royal' || currentLocation === 'The Crown' || currentLocation === 'Seabreeze') {
                    const selectedStaffId = document.getElementById('selectedStaffId').value;
                    if (!selectedStaffId) {
                        alert('Please select a staff member from the dropdown.');
                        return;
                    }
                    
                    const selectedStaff = staffProfiles.find(s => s.id == selectedStaffId);
                    if (!selectedStaff) {
                        alert('Selected staff member not found. Please try again.');
                        return;
                    }
                    
                    firstName = selectedStaff.first_name;
                    surname = selectedStaff.last_name;
                } else {
                    firstName = document.getElementById('firstName').value.trim();
                    surname = document.getElementById('surname').value.trim();
                    
                    if (!firstName || !surname) {
                        alert('Please enter both first name and surname.');
                        return;
                    }
                }
            } else {
                // For visitors - always use text input
                firstName = document.getElementById('firstName').value.trim();
                surname = document.getElementById('surname').value.trim();
                
                if (!firstName || !surname) {
                    alert('Please enter both first name and surname.');
                    return;
                }
            }

            const email = document.getElementById('email') ? document.getElementById('email').value.trim() : '';
            const mobile = document.getElementById('mobile') ? document.getElementById('mobile').value.trim() : '';

            const data = {
                firstName: firstName,
                surname: surname,
                email: email || 'Not provided',
                mobile: mobile || 'Not provided',
                userType: APP.currentUserType,
                location: getLocationName(),
                arrivalDate: new Date().toLocaleDateString(),
                arrivalTime: new Date().toLocaleTimeString(),
                status: 'arrived',
                timestamp: new Date().toISOString()
            };

            saveToStorage(data);
            showSuccess(`üéâ Welcome, ${firstName} ${surname}!`, `Your arrival has been recorded as a ${APP.currentUserType}.`);
        }

        function doRecordDeparture() {
            let firstName, surname;
            
            // Check if this is a client departure with dropdown selection
            if (APP.currentUserType === 'client') {
                const currentLocation = getLocationName();
                if (currentLocation === 'The Royal' || currentLocation === 'The Crown' || currentLocation === 'Seabreeze') {
                    const selectedClientId = document.getElementById('selectedDepartureClientId').value;
                    if (!selectedClientId) {
                        alert('Please select a client from the dropdown.');
                        return;
                    }
                    
                    const selectedClient = clientProfiles.find(c => c.id == selectedClientId);
                    if (!selectedClient) {
                        alert('Selected client not found. Please try again.');
                        return;
                    }
                    
                    firstName = selectedClient.first_name;
                    surname = selectedClient.last_name;
                } else {
                    // For other locations, use text input
                    firstName = document.getElementById('leaveFirst').value.trim();
                    surname = document.getElementById('leaveLast').value.trim();
                    
                    if (!firstName || !surname) {
                        alert('Please enter both first name and surname.');
                        return;
                    }
                }
            } else if (APP.currentUserType === 'staff' && (getLocationName() === 'The Royal' || getLocationName() === 'The Crown' || getLocationName() === 'Seabreeze')) {
                const selectedStaffId = document.getElementById('selectedDepartureStaffId').value;
                if (!selectedStaffId) {
                    alert('Please select a staff member from the dropdown.');
                    return;
                }
                
                const selectedStaff = staffProfiles.find(s => s.id == selectedStaffId);
                if (!selectedStaff) {
                    alert('Selected staff member not found. Please try again.');
                    return;
                }
                
                firstName = selectedStaff.first_name;
                surname = selectedStaff.last_name;
            } else {
                // For visitors and staff at other locations, use text input
                firstName = document.getElementById('leaveFirst').value.trim();
                surname = document.getElementById('leaveLast').value.trim();
                
                if (!firstName || !surname) {
                    alert('Please enter both first name and surname.');
                    return;
                }
            }

            currentDepartingVisitor = {
                firstName: firstName,
                surname: surname,
                email: 'Not provided',
                mobile: 'Not provided',
                userType: APP.currentUserType,
                location: getLocationName(),
                departureDate: new Date().toLocaleDateString(),
                departureTime: new Date().toLocaleTimeString(),
                status: 'departed',
                timestamp: new Date().toISOString()
            };

            if (APP.currentUserType === 'visitor') {
                showPage('feedbackPage');
                setupStarRatings();
                saveSessionState(); // Save state when on feedback page
            } else if (APP.currentUserType === 'staff') {
                saveToStorage(currentDepartingVisitor);
                showSuccess(`üòä Thank you for today ${firstName} ${surname}. You are the reason someone smiled today!`, 'Your departure has been recorded.');
            } else if (APP.currentUserType === 'client') {
                saveToStorage(currentDepartingVisitor);
                showSuccess(`‚òÄÔ∏è We hope you had the best day ${firstName} ${surname}, see you soon!`, 'Your departure has been recorded.');
            }
        }

        function saveToStorage(data) {
            console.log('üíæ saveToStorage() called with:', data); // DEBUG LINE
            try {
                // Get existing data
                const existingData = JSON.parse(localStorage.getItem('hellohubVisitors') || '[]');
                
                // Check if this is a departure - try to find matching arrival record
                if (data.status === 'departed') {
                    const matchingIndex = findMatchingArrival(existingData, data);
                    
                    if (matchingIndex !== -1) {
                        console.log('Found matching arrival record, updating existing entry');
                        // Update the existing record with departure info
                        const existingRecord = existingData[matchingIndex];
                        
                        // Keep the original arrival data and add departure data
                        existingData[matchingIndex] = {
                            ...existingRecord, // Keep all original data (email, mobile, arrival times)
                            // Update with departure information
                            departureDate: data.departureDate,
                            departureTime: data.departureTime,
                            status: 'departed',
                            timestamp: data.timestamp, // Update timestamp to departure time
                            // Add feedback if it exists (only visitors provide feedback)
                            ...(data.feedback ? { feedback: data.feedback } : {})
                        };
                        
                        console.log('Updated existing record:', existingData[matchingIndex]);
                    } else {
                        console.log('No matching arrival found, creating new departure record');
                        // No matching arrival found, create new record
                        existingData.unshift(data);
                    }
                } else {
                    console.log('New arrival record');
                    // This is an arrival, just add it normally
                    existingData.unshift(data);
                }
                
                // Save back to localStorage
                localStorage.setItem('hellohubVisitors', JSON.stringify(existingData));
                console.log('Data saved successfully to localStorage');
                
                // Send to Supabase - WORKING VERSION
                console.log('üì§ Sending to Supabase...');
                
                const supabaseData = {
                    first_name: data.firstName || null,
                    surname: data.surname || null,
                    email: data.email === 'Not provided' ? null : data.email,
                    mobile: data.mobile === 'Not provided' ? null : data.mobile,
                    user_type: data.userType || null,
                    location: data.location || null,
                    status: data.status || null,
                    arrival_date: data.arrivalDate || null,
                    arrival_time: data.arrivalTime || null,
                    departure_date: data.departureDate || null,
                    departure_time: data.departureTime || null,
                    feedback_overall: data.feedback?.overall || null,
                    feedback_safety: data.feedback?.safety || null,
                    feedback_responsive: data.feedback?.responsive || null,
                    feedback_caring: data.feedback?.caring || null,
                    feedback_leadership: data.feedback?.leadership || null,
                    feedback_effectiveness: data.feedback?.effectiveness || null,
                    feedback_average: data.feedback ? calculateFeedbackAverage(data.feedback) : null,
                    feedback_comments: data.feedback?.additionalComments || null
                };
                
                fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/visitors`, {
                    method: 'POST',
                    headers: {
                        'apikey': VISITOR_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(supabaseData)
                })
                .then(response => {
                    console.log('üì° Supabase response status:', response.status);
                    if (response.ok) {
                        return response.json();
                    } else {
                        return response.text().then(text => {
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                })
                .then(result => {
                    console.log('‚úÖ Data synced to Supabase successfully:', result);
                })
                .catch(error => {
                    handleApiError(error, 'Syncing visitor data to database');
                });
                
                return true;
            } catch (error) {
                console.log('Save failed:', error);
                return false;
            }
        }

        function findMatchingArrival(existingData, departureData) {
            // Look for a matching person who has arrived but not yet departed
            // Match based on name, user type, and location on the same day
            const departureDate = departureData.departureDate;
            
            for (let i = 0; i < existingData.length; i++) {
                const record = existingData[i];
                
                // Check if names match (case insensitive, flexible matching)
                const firstNameMatch = record.firstName.toLowerCase().trim() === departureData.firstName.toLowerCase().trim();
                const surnameMatch = record.surname.toLowerCase().trim() === departureData.surname.toLowerCase().trim();
                
                // Check other criteria
                const userTypeMatch = record.userType === departureData.userType;
                const locationMatch = record.location === departureData.location;
                const statusMatch = record.status === 'arrived'; // Only match with arrivals
                const sameDayMatch = record.arrivalDate === departureDate; // Same day
                
                if (firstNameMatch && surnameMatch && userTypeMatch && locationMatch && statusMatch && sameDayMatch) {
                    console.log('Found matching arrival:', record);
                    return i;
                }
            }
            
            console.log('No matching arrival found for:', departureData.firstName, departureData.surname);
            return -1; // No match found
        }

        function calculateFeedbackAverage(feedback) {
            const ratings = [
                feedback.overall || 0,
                feedback.safety || 0,
                feedback.responsive || 0,
                feedback.caring || 0,
                feedback.leadership || 0,
                feedback.effectiveness || 0
            ];
            
            const validRatings = ratings.filter(rating => rating > 0);
            if (validRatings.length === 0) return null;
            
            const sum = validRatings.reduce((total, rating) => total + rating, 0);
            return (sum / validRatings.length).toFixed(2);
        }

        function showSuccess(personalMessage, systemMessage) {
            document.getElementById('successMsg').textContent = personalMessage;
            document.getElementById('successDetails').textContent = systemMessage;
            showPage('successPage');
            saveSessionState(); // Save state when showing success page
            startCountdown();
        }

        function startCountdown() {
            let seconds = 5;
            const countdownEl = document.getElementById('countdown');
            
            const updateCountdown = () => {
                countdownEl.textContent = `Returning in ${seconds} seconds...`;
                seconds--;
                
                if (seconds < 0) {
                    APP.currentUserType = '';
                    document.querySelectorAll('.user-type-btn').forEach(btn => btn.classList.remove('active'));
                    showPage('userTypeSelect');
                    saveSessionState(); // Save state when countdown completes
                } else {
                    setTimeout(updateCountdown, 1000);
                }
            };
            
            updateCountdown();
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function doGoBack() {
            // Determine where to go back to based on current context
            const activePage = document.querySelector('.page.active').id;
            
            if (activePage === 'staffAuthPage' || activePage === 'clientManagementPage' || activePage === 'addClientPage') {
                if (activePage === 'addClientPage') {
                    showPage('clientManagementPage');
                } else if (activePage === 'clientManagementPage') {
                    showPage('arrivingPage');
                    buildArrivalForm(); // Rebuild the form to show the client dropdown again
                } else {
                    showPage('arrivingPage');
                    buildArrivalForm();
                }
            } else if (activePage === 'staffManagementPage' || activePage === 'addStaffPage') {
                if (activePage === 'addStaffPage') {
                    showPage('staffManagementPage');
                } else if (activePage === 'staffManagementPage') {
                    showPage('arrivingPage');
                    buildArrivalForm(); // Rebuild the form to show the staff dropdown again
                } else {
                    showPage('arrivingPage');
                    buildArrivalForm();
                }
            } else {
                showPage('userTypeSelect');
            }
            saveSessionState(); // Save state when going back
        }

        function adminReset() {
            // Only allow admin reset if user is logged in
            if (!APP.company || APP.company === '') {
                return; // Do nothing if not logged in
            }
            
            APP.adminClicks++;
            setTimeout(() => { APP.adminClicks = 0; }, 2000);
            if (APP.adminClicks >= 3) {
                // Clear location data
                APP.currentBusiness = '';
                APP.currentUserType = '';
                document.getElementById('businessDropdown').value = '';
                document.querySelectorAll('.user-type-btn').forEach(btn => btn.classList.remove('active'));
                
                // Remove location backgrounds and reset location display
                document.body.classList.remove('location-the-royal', 'location-the-crown', 'location-seabreeze');
                document.getElementById('locationName').style.display = 'none';
                document.getElementById('locationName').textContent = '';
                
                // Update header to show company but no location
                updateHeader();
                
                // Update session
                saveSessionState();
                
                showPage('businessSelect');
            }
        }

        // Session state management
        function saveSessionState() {
            const sessionState = {
                company: APP.company,
                locations: APP.locations,
                currentBusiness: APP.currentBusiness,
                currentUserType: APP.currentUserType,
                isLoggedIn: APP.company !== '',
                currentPage: getCurrentActivePage(),
                // Save departing visitor data for feedback page restoration
                currentDepartingVisitor: currentDepartingVisitor
            };
            localStorage.setItem('hellohubSession', JSON.stringify(sessionState));
        }

        function getCurrentActivePage() {
            const activePages = document.querySelectorAll('.page.active');
            if (activePages.length > 0) {
                return activePages[0].id;
            }
            return 'loginPage';
        }

        function restoreSessionState() {
            // First, check for auto-login
            const autoLoggedIn = checkAutoLogin();
            
            const savedSession = localStorage.getItem('hellohubSession');
            
            // Check if this is a fresh browser session (new tab/window)
            const isNewBrowserSession = !sessionStorage.getItem('hellohubActive');
            
            // Mark this browser tab as active
            sessionStorage.setItem('hellohubActive', 'true');
            
            if (autoLoggedIn) {
                console.log('Auto-login successful');
                
                if (savedSession) {
                    try {
                        const sessionState = JSON.parse(savedSession);
                        
                        // Restore business and user type if available
                        if (sessionState.currentBusiness) {
                            APP.currentBusiness = sessionState.currentBusiness;
                            document.getElementById('businessDropdown').value = APP.currentBusiness;
                            updateHeader();
                            fastSwitchLocation();
                            
                            if (sessionState.currentUserType) {
                                APP.currentUserType = sessionState.currentUserType;
                                document.querySelectorAll('.user-type-btn').forEach(btn => {
                                    btn.classList.remove('active');
                                    if (btn.onclick.toString().includes(`'${APP.currentUserType}'`)) {
                                        btn.classList.add('active');
                                    }
                                });
                                showPageWithoutSaving('userTypeSelect');
                            } else {
                                showPageWithoutSaving('userTypeSelect');
                            }
                        } else {
                            showPageWithoutSaving('businessSelect');
                        }
                        
                        saveSessionState();
                        return;
                        
                    } catch (error) {
                        console.log('Error parsing session after auto-login');
                        showPageWithoutSaving('businessSelect');
                        return;
                    }
                } else {
                    // Auto-logged in but no session data
                    showPageWithoutSaving('businessSelect');
                    return;
                }
            }
            
            // If no auto-login, start fresh
            if (savedSession) {
                try {
                    const sessionState = JSON.parse(savedSession);
                    
                    // Check if we have a complete, valid session
                    const hasCompleteSession = sessionState.isLoggedIn && 
                                              sessionState.company && 
                                              sessionState.locations && 
                                              sessionState.locations.length > 0;
                    
                    if (hasCompleteSession && !isNewBrowserSession) {
                        // Browser refresh: Restore full state
                        console.log('Browser refresh detected, restoring full state');
                        
                        APP.company = sessionState.company;
                        APP.locations = sessionState.locations;
                        APP.currentBusiness = sessionState.currentBusiness || '';
                        APP.currentUserType = sessionState.currentUserType || '';
                        
                        setupBusinessDropdown();
                        if (APP.currentBusiness) {
                            document.getElementById('businessDropdown').value = APP.currentBusiness;
                            updateHeader();
                            fastSwitchLocation();
                        }
                        
                        if (APP.currentUserType) {
                            document.querySelectorAll('.user-type-btn').forEach(btn => {
                                btn.classList.remove('active');
                                if (btn.onclick.toString().includes(`'${APP.currentUserType}'`)) {
                                    btn.classList.add('active');
                                }
                            });
                        }
                        
                        showPageWithoutSaving(sessionState.currentPage || 'userTypeSelect');
                    } else {
                        console.log('Fresh session or incomplete state, starting at login');
                        localStorage.removeItem('hellohubSession');
                        resetToLoginPage();
                    }
                } catch (error) {
                    console.log('Error parsing session, starting fresh');
                    localStorage.removeItem('hellohubSession');
                    resetToLoginPage();
                }
            } else {
                console.log('No saved session, starting at login page');
                resetToLoginPage();
            }
        }

        function resetToLoginPage() {
            APP.company = '';
            APP.locations = [];
            APP.currentBusiness = '';
            APP.currentUserType = '';
            
            document.getElementById('headerTitle').textContent = 'üëã HelloHub';
            document.getElementById('headerSubtitle').textContent = 'Visitor, Client & Staff Management';
            document.getElementById('locationName').style.display = 'none';
            document.getElementById('locationName').textContent = ''; // Clear any leftover text
            document.getElementById('headerLogo').style.display = 'none';
            
            document.body.classList.remove('alex-davis-logged-in');
            document.body.classList.remove('location-the-royal', 'location-the-crown', 'location-seabreeze');
            
            showPageWithoutSaving('loginPage');
        }

        function showPageWithoutSaving(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // Add remaining helper functions
        function populateStaffOptions() {
            // Similar to client options but for staff
            const optionsDiv = document.getElementById('staffOptions');
            if (!optionsDiv) return;

            if (staffProfiles.length === 0) {
                loadStaffProfiles().then(() => {
                    populateStaffOptionsInternal();
                });
            } else {
                populateStaffOptionsInternal();
            }
        }

        function populateStaffOptionsInternal() {
            const optionsDiv = document.getElementById('staffOptions');
            if (!optionsDiv) return;

            const currentLocation = getLocationName();
            const locationStaff = staffProfiles.filter(staff => 
                (staff.location || '').trim().toLowerCase() === currentLocation.trim().toLowerCase()
            );

            if (locationStaff.length === 0) {
                optionsDiv.innerHTML = '<div class="client-option" style="color: #666; font-style: italic;">No staff registered for this location</div>';
                return;
            }

            locationStaff.sort((a, b) => a.first_name.localeCompare(b.first_name));

            optionsDiv.innerHTML = '';
            locationStaff.forEach(staff => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'client-option';
                optionDiv.onclick = () => selectStaff(staff);
                
                optionDiv.innerHTML = `
                    <img class="client-photo" src="${staff.photo_url || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'18\' fill=\'%23f8f9fa\' stroke=\'%23e0e0e0\' stroke-width=\'2\'/%3E%3Ctext x=\'20\' y=\'26\' text-anchor=\'middle\' font-size=\'12\' fill=\'%23666\'%3Eüë§%3C/text%3E%3C/svg%3E'}" alt="${staff.first_name} ${staff.last_name}">
                    <span class="client-name">${staff.first_name} ${staff.last_name}</span>
                `;
                
                optionsDiv.appendChild(optionDiv);
            });
        }

        function toggleStaffOptions() {
            const optionsDiv = document.getElementById('staffOptions');
            if (optionsDiv.style.display === 'none' || !optionsDiv.style.display) {
                optionsDiv.style.display = 'block';
                ultraFastPopulateStaff();
            } else {
                optionsDiv.style.display = 'none';
            }
        }

        function ultraFastPopulateStaff() {
            const optionsDiv = document.getElementById('staffOptions');
            if (!optionsDiv) return;

            const currentLocation = getLocationName();
            
            const cachedData = dataCache.staff.get(currentLocation);
            if (cachedData) {
                const locationStaff = cachedData.data.filter(staff => 
                    (staff.location || '').trim().toLowerCase() === currentLocation.trim().toLowerCase()
                );
                
                renderStaffOptions(optionsDiv, locationStaff, currentLocation);
                return;
            }
            
            optionsDiv.innerHTML = '<div class="client-option" style="padding: 15px; text-align: center; color: #666;">‚ö° Loading...</div>';
            
            loadStaffProfilesForLocation(currentLocation).then(data => {
                staffProfiles = data;
                const locationStaff = data.filter(staff => 
                    (staff.location || '').trim().toLowerCase() === currentLocation.trim().toLowerCase()
                );
                renderStaffOptions(optionsDiv, locationStaff, currentLocation);
            });
        }

        function renderStaffOptions(optionsDiv, staff, location) {
            if (staff.length === 0) {
                optionsDiv.innerHTML = `<div class="client-option" style="color: #666; font-style: italic; padding: 15px; text-align: center;">No staff for ${location}</div>`;
                return;
            }

            staff.sort((a, b) => a.first_name.localeCompare(b.first_name));

            const html = staff.map(member => `
                <div class="client-option" onclick="selectStaff(${JSON.stringify(member).replace(/"/g, '&quot;')})">
                    <img class="client-photo" src="${member.photo_url || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'18\' fill=\'%23f8f9fa\' stroke=\'%23e0e0e0\' stroke-width=\'2\'/%3E%3Ctext x=\'20\' y=\'26\' text-anchor=\'middle\' font-size=\'12\' fill=\'%23666\'%3Eüë§%3C/text%3E%3C/svg%3E'}" alt="${member.first_name} ${member.last_name}">
                    <span class="client-name">${member.first_name} ${member.last_name}</span>
                </div>
            `).join('');

            optionsDiv.innerHTML = html;
        }

        function selectStaff(staff) {
            document.getElementById('staffSelect').textContent = `${staff.first_name} ${staff.last_name}`;
            document.getElementById('selectedStaffId').value = staff.id;
            document.getElementById('staffOptions').style.display = 'none';
        }

        function populateDepartureClientOptions() {
            const optionsDiv = document.getElementById('departureClientOptions');
            if (!optionsDiv) return;

            if (clientProfiles.length === 0) {
                loadClientProfiles().then(() => {
                    populateDepartureClientOptionsInternal();
                });
            } else {
                populateDepartureClientOptionsInternal();
            }
        }

        function populateDepartureClientOptionsInternal() {
            const optionsDiv = document.getElementById('departureClientOptions');
            if (!optionsDiv) return;

            const currentLocation = getLocationName();
            const locationClients = clientProfiles.filter(client => 
                (client.location || '').trim().toLowerCase() === currentLocation.trim().toLowerCase()
            );

            if (locationClients.length === 0) {
                optionsDiv.innerHTML = '<div class="client-option" style="color: #666; font-style: italic;">No clients registered for this location</div>';
                return;
            }

            locationClients.sort((a, b) => a.first_name.localeCompare(b.first_name));

            optionsDiv.innerHTML = '';
            locationClients.forEach(client => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'client-option';
                optionDiv.onclick = () => selectDepartureClient(client);
                
                optionDiv.innerHTML = `
                    <img class="client-photo" src="${client.photo_url || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'18\' fill=\'%23f8f9fa\' stroke=\'%23e0e0e0\' stroke-width=\'2\'/%3E%3Ctext x=\'20\' y=\'26\' text-anchor=\'middle\' font-size=\'12\' fill=\'%23666\'%3Eüë§%3C/text%3E%3C/svg%3E'}" alt="${client.first_name} ${client.last_name}">
                    <span class="client-name">${client.first_name} ${client.last_name}</span>
                `;
                
                optionsDiv.appendChild(optionDiv);
            });
        }

        function toggleDepartureClientOptions() {
            const optionsDiv = document.getElementById('departureClientOptions');
            if (optionsDiv.style.display === 'none' || !optionsDiv.style.display) {
                optionsDiv.style.display = 'block';
                showLoadingOptions('departureClientOptions');
                populateDepartureClientOptions();
            } else {
                optionsDiv.style.display = 'none';
            }
        }

        function selectDepartureClient(client) {
            document.getElementById('departureClientSelect').textContent = `${client.first_name} ${client.last_name}`;
            document.getElementById('selectedDepartureClientId').value = client.id;
            document.getElementById('departureClientOptions').style.display = 'none';
        }

        function populateDepartureStaffOptions() {
            const optionsDiv = document.getElementById('departureStaffOptions');
            if (!optionsDiv) return;

            if (staffProfiles.length === 0) {
                loadStaffProfiles().then(() => {
                    populateDepartureStaffOptionsInternal();
                });
            } else {
                populateDepartureStaffOptionsInternal();
            }
        }

        function populateDepartureStaffOptionsInternal() {
            const optionsDiv = document.getElementById('departureStaffOptions');
            if (!optionsDiv) return;

            const currentLocation = getLocationName();
            const locationStaff = staffProfiles.filter(staff => 
                (staff.location || '').trim().toLowerCase() === currentLocation.trim().toLowerCase()
            );

            if (locationStaff.length === 0) {
                optionsDiv.innerHTML = '<div class="client-option" style="color: #666; font-style: italic;">No staff registered for this location</div>';
                return;
            }

            locationStaff.sort((a, b) => a.first_name.localeCompare(b.first_name));

            optionsDiv.innerHTML = '';
            locationStaff.forEach(staff => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'client-option';
                optionDiv.onclick = () => selectDepartureStaff(staff);
                
                optionDiv.innerHTML = `
                    <img class="client-photo" src="${staff.photo_url || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Ccircle cx=\'20\' cy=\'20\' r=\'18\' fill=\'%23f8f9fa\' stroke=\'%23e0e0e0\' stroke-width=\'2\'/%3E%3Ctext x=\'20\' y=\'26\' text-anchor=\'middle\' font-size=\'12\' fill=\'%23666\'%3Eüë§%3C/text%3E%3C/svg%3E'}" alt="${staff.first_name} ${staff.last_name}">
                    <span class="client-name">${staff.first_name} ${staff.last_name}</span>
                `;
                
                optionsDiv.appendChild(optionDiv);
            });
        }

        function toggleDepartureStaffOptions() {
            const optionsDiv = document.getElementById('departureStaffOptions');
            if (optionsDiv.style.display === 'none' || !optionsDiv.style.display) {
                optionsDiv.style.display = 'block';
                showLoadingOptions('departureStaffOptions');
                populateDepartureStaffOptions();
            } else {
                optionsDiv.style.display = 'none';
            }
        }

        function selectDepartureStaff(staff) {
            document.getElementById('departureStaffSelect').textContent = `${staff.first_name} ${staff.last_name}`;
            document.getElementById('selectedDepartureStaffId').value = staff.id;
            document.getElementById('departureStaffOptions').style.display = 'none';
        }

        function showClientSettings() {
            showPage('staffAuthPage');
            saveSessionState();
        }

        function showStaffSettings() {
            showPage('staffAuthPage');
            saveSessionState();
        }

        function doStaffLogin() {
            const password = document.getElementById('staffPassword').value.trim();
            
            if (!password) {
                showStaffError('Please enter the staff password.');
                return;
            }
            
            if (password === 'office927') {
                document.getElementById('staffPassword').value = '';
                hideStaffError();
                
                // Check if we're managing staff or clients
                if (APP.currentUserType === 'staff' && (getLocationName() === 'The Royal' || getLocationName() === 'The Crown' || getLocationName() === 'Seabreeze')) {
                    showPage('staffManagementPage');
                    document.getElementById('currentStaffLocationSpan').textContent = getLocationName();
                    displayStaffList();
                } else {
                    showPage('clientManagementPage');
                    document.getElementById('currentLocationSpan').textContent = getLocationName();
                    displayClientList();
                }
                saveSessionState();
            } else {
                showStaffError('Invalid staff password.');
            }
        }

        function showStaffError(message) {
            const errorDiv = document.getElementById('staffLoginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideStaffError() {
            document.getElementById('staffLoginError').style.display = 'none';
        }

        function displayClientList() {
            const clientListDiv = document.getElementById('clientList');
            const currentLocation = getLocationName();
            
            if (clientProfiles.length === 0) {
                loadClientProfiles().then(() => {
                    displayClientListInternal();
                });
            } else {
                displayClientListInternal();
            }
        }

        function displayClientListInternal() {
            const clientListDiv = document.getElementById('clientList');
            const currentLocation = getLocationName();
            const locationClients = clientProfiles.filter(client => 
                (client.location || '').trim().toLowerCase() === currentLocation.trim().toLowerCase()
            );

            if (locationClients.length === 0) {
                clientListDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">No clients registered for this location yet.</div>';
                return;
            }

            locationClients.sort((a, b) => a.first_name.localeCompare(b.first_name));

            let html = '';
            locationClients.forEach(client => {
                html += `
                    <div class="client-card">
                        <img class="client-card-photo" src="${client.photo_url || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\' viewBox=\'0 0 60 60\'%3E%3Ccircle cx=\'30\' cy=\'30\' r=\'28\' fill=\'%23f8f9fa\' stroke=\'%23e0e0e0\' stroke-width=\'2\'/%3E%3Ctext x=\'30\' y=\'38\' text-anchor=\'middle\' font-size=\'18\' fill=\'%23666\'%3Eüë§%3C/text%3E%3C/svg%3E'}" alt="${client.first_name} ${client.last_name}">
                        <div class="client-card-info">
                            <div class="client-card-name">${client.first_name} ${client.last_name}</div>
                            <div class="client-card-location">${client.location}</div>
                        </div>
                        <div class="client-card-actions">
                            <button class="btn btn-primary btn-small" onclick="editClient(${client.id})">‚úèÔ∏è Edit</button>
                            <button class="btn btn-warning btn-small" onclick="deleteClient(${client.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });

            clientListDiv.innerHTML = html;
        }

        function displayStaffList() {
            const staffListDiv = document.getElementById('staffList');
            const currentLocation = getLocationName();
            
            if (staffProfiles.length === 0) {
                loadStaffProfiles().then(() => {
                    displayStaffListInternal();
                });
            } else {
                displayStaffListInternal();
            }
        }

        function displayStaffListInternal() {
            const staffListDiv = document.getElementById('staffList');
            const currentLocation = getLocationName();
            const locationStaff = staffProfiles.filter(staff => 
                (staff.location || '').trim().toLowerCase() === currentLocation.trim().toLowerCase()
            );

            if (locationStaff.length === 0) {
                staffListDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">No staff registered for this location yet.</div>';
                return;
            }

            locationStaff.sort((a, b) => a.first_name.localeCompare(b.first_name));

            let html = '';
            locationStaff.forEach(staff => {
                html += `
                    <div class="client-card">
                        <img class="client-card-photo" src="${staff.photo_url || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\' viewBox=\'0 0 60 60\'%3E%3Ccircle cx=\'30\' cy=\'30\' r=\'28\' fill=\'%23f8f9fa\' stroke=\'%23e0e0e0\' stroke-width=\'2\'/%3E%3Ctext x=\'30\' y=\'38\' text-anchor=\'middle\' font-size=\'18\' fill=\'%23666\'%3Eüë§%3C/text%3E%3C/svg%3E'}" alt="${staff.first_name} ${staff.last_name}">
                        <div class="client-card-info">
                            <div class="client-card-name">${staff.first_name} ${staff.last_name}</div>
                            <div class="client-card-location">${staff.location}</div>
                        </div>
                        <div class="client-card-actions">
                            <button class="btn btn-primary btn-small" onclick="editStaff(${staff.id})">‚úèÔ∏è Edit</button>
                            <button class="btn btn-warning btn-small" onclick="deleteStaff(${staff.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });

            staffListDiv.innerHTML = html;
        }

        function setupStarRatings() {
            const starRatings = document.querySelectorAll('.star-rating');
            
            // First, reset all star ratings to fresh state
            starRatings.forEach(rating => {
                rating.dataset.selectedRating = '0'; // Reset to no rating
                const stars = rating.querySelectorAll('.star');
                stars.forEach(star => {
                    star.classList.remove('selected');
                    star.style.opacity = '0.3';
                    star.style.transform = 'scale(1)';
                });
            });
            
            starRatings.forEach(rating => {
                const stars = rating.querySelectorAll('.star');
                
                stars.forEach((star, index) => {
                    star.addEventListener('click', function() {
                        const selectedRating = parseInt(this.dataset.rating);
                        
                        // Clear all stars first
                        stars.forEach(s => s.classList.remove('selected'));
                        
                        // Light up all stars from 1 to the selected rating
                        for (let i = 0; i < selectedRating; i++) {
                            stars[i].classList.add('selected');
                        }
                        
                        // Store the rating
                        rating.dataset.selectedRating = selectedRating;
                        
                        console.log(`Rated ${rating.dataset.question}: ${selectedRating} stars`);
                    });
                    
                    // Hover effect - show preview of what would be selected
                    star.addEventListener('mouseenter', function() {
                        const hoverRating = parseInt(this.dataset.rating);
                        stars.forEach((s, i) => {
                            if (i < hoverRating) {
                                s.style.opacity = '0.8';
                                s.style.transform = 'scale(1.05)';
                            } else {
                                s.style.opacity = '0.3';
                                s.style.transform = 'scale(1)';
                            }
                        });
                    });
                    
                    // Reset hover effect
                    star.addEventListener('mouseleave', function() {
                        const selectedRating = rating.dataset.selectedRating || 0;
                        stars.forEach((s, i) => {
                            if (i < selectedRating) {
                                s.style.opacity = '1';
                                s.style.transform = 'scale(1)';
                                s.classList.add('selected');
                            } else {
                                s.style.opacity = '0.3';
                                s.style.transform = 'scale(1)';
                                s.classList.remove('selected');
                            }
                        });
                    });
                });
            });
        }

        function doSubmitFeedback() {
            const ratings = {};
            const starRatings = document.querySelectorAll('.star-rating');
            
            starRatings.forEach(rating => {
                const questionName = rating.dataset.question;
                const selectedRating = rating.dataset.selectedRating || 0;
                ratings[questionName] = parseInt(selectedRating);
            });
            
            const additionalFeedback = document.getElementById('additionalFeedback').value.trim();
            
            currentDepartingVisitor.feedback = {
                overall: ratings.overall || 0,
                safety: ratings.safety || 0,
                responsive: ratings.responsive || 0,
                caring: ratings.caring || 0,
                leadership: ratings.leadership || 0,
                effectiveness: ratings.effectiveness || 0,
                additionalComments: additionalFeedback || 'No additional comments'
            };
            
            saveToStorage(currentDepartingVisitor);
            showSuccess(`üíù Thank you for visiting ${currentDepartingVisitor.firstName} ${currentDepartingVisitor.surname}, we value your feedback about our home.`, 'Your departure and feedback have been recorded.');
        }

        // Logout timer functionality
        let logoutTimer = null;
        let logoutProgress = 0;

        function startLogoutTimer() {
            const logo = document.getElementById('headerLogo');
            if (!logo || logo.style.display === 'none') return;
            
            logoutProgress = 0;
            
            logoutTimer = setInterval(() => {
                logoutProgress += 100; // 100ms intervals
                
                // Visual feedback - darken the logo progressively
                const opacity = 1 - (logoutProgress / 6000) * 0.7; // Darken to 30% opacity
                logo.style.opacity = opacity;
                
                if (logoutProgress >= 6000) { // 6 seconds
                    performLogout();
                    cancelLogoutTimer();
                }
            }, 100);
        }

        function cancelLogoutTimer() {
            if (logoutTimer) {
                clearInterval(logoutTimer);
                logoutTimer = null;
                
                // Reset logo appearance
                const logo = document.getElementById('headerLogo');
                if (logo) {
                    logo.style.opacity = 1;
                }
            }
        }

        function performLogout() {
            // Clear saved login
            localStorage.removeItem('hellohubAuth');
            
            // Reset all APP data
            APP.currentBusiness = '';
            APP.currentUserType = '';
            APP.company = '';
            APP.locations = [];
            
            // Reset UI elements
            document.getElementById('businessDropdown').value = '';
            document.querySelectorAll('.user-type-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('headerTitle').textContent = 'üëã HelloHub';
            document.getElementById('headerSubtitle').textContent = 'Visitor, Client & Staff Management';
            
            // Clear location name completely
            document.getElementById('locationName').style.display = 'none';
            document.getElementById('locationName').textContent = '';
            
            // Remove all background classes and hide logo
            document.body.classList.remove('alex-davis-logged-in');
            document.body.classList.remove('location-the-royal', 'location-the-crown', 'location-seabreeze');
            document.getElementById('headerLogo').style.display = 'none';
            document.getElementById('headerLogo').style.opacity = 1;
            
            // Clear session data
            localStorage.removeItem('hellohubSession');
            
            // Go back to login page
            showPage('loginPage');
        }

        // Initialize when page loads
        
        // Enhanced iPad-compatible event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up iPad-compatible event listeners');
            
            // Get form elements with safety checks
            const emailField = document.getElementById('emailAddress');
            const passwordField = document.getElementById('password');
            const loginForm = document.getElementById('loginForm');
            const loginButton = document.getElementById('loginButton');
            
            if (!emailField || !passwordField || !loginForm || !loginButton) {
                console.error('Login form elements not found');
                return;
            }
            
            // Enhanced Enter key support for iPad
            emailField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    // Focus on password field if email has content
                    if (this.value.trim()) {
                        passwordField.focus();
                    }
                }
            });
            
            passwordField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    handleLoginSubmit(e);
                }
            });
            
            // Enhanced form submission handling for iPad
            loginForm.addEventListener('submit', handleLoginSubmit);
            
            // Comprehensive iPad touch event support
            let touchStartTime = 0;
            
            loginButton.addEventListener('touchstart', function(e) {
                console.log('Touch start on login button');
                touchStartTime = Date.now();
                e.stopPropagation();
                // Visual feedback
                this.style.transform = 'scale(0.98)';
            }, {passive: true});
            
            loginButton.addEventListener('touchend', function(e) {
                console.log('Touch end on login button');
                const touchDuration = Date.now() - touchStartTime;
                
                // Reset visual feedback
                this.style.transform = 'scale(1)';
                
                // Only trigger if it was a quick tap (not a long press)
                if (touchDuration < 1000) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Triggering iPad login submission');
                    handleLoginSubmit(e);
                }
            }, {passive: false});
            
            // Additional iPad-specific click handler as fallback
            loginButton.addEventListener('click', function(e) {
                console.log('Click event on login button');
                e.preventDefault();
                e.stopPropagation();
                handleLoginSubmit(e);
            });
            
            // Fix iPad Safari input issues
            [emailField, passwordField].forEach(field => {
                // Focus enhancement for iPad
                field.addEventListener('focus', function() {
                    console.log('Input field focused:', this.id);
                    // Small delay to ensure iPad Safari processes focus correctly
                    setTimeout(() => {
                        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                });
                
                // Blur enhancement for iPad
                field.addEventListener('blur', function() {
                    console.log('Input field blurred:', this.id);
                });
                
                // Input enhancement for iPad
                field.addEventListener('input', function() {
                    // Clear any existing errors when user starts typing
                    hideError();
                });
            });
            
            // Add click outside to close client dropdown
            document.addEventListener('click', function(e) {
                // Close arrival dropdown
                const dropdown = document.getElementById('clientOptions');
                const select = document.getElementById('clientSelect');
                if (dropdown && select && !select.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
                
                // Close departure dropdown
                const departureDropdown = document.getElementById('departureClientOptions');
                const departureSelect = document.getElementById('departureClientSelect');
                if (departureDropdown && departureSelect && !departureSelect.contains(e.target) && !departureDropdown.contains(e.target)) {
                    departureDropdown.style.display = 'none';
                }
            });
            
            // Restore session state from localStorage
            restoreSessionState();
        });

        // Client Management Functions
        function loadClientProfiles() {
            const currentLocation = getLocationName();
            if (!currentLocation || (currentLocation !== 'The Royal' && currentLocation !== 'The Crown' && currentLocation !== 'Seabreeze')) {
                return Promise.resolve([]);
            }

            // Fetch from Supabase
            return fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/client_profiles?location=eq.${currentLocation}&select=*`, {
                method: 'GET',
                headers: {
                    'apikey': VISITOR_CONFIG.supabaseAnonKey,
                    'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                clientProfiles = data || [];
                console.log('Loaded client profiles:', clientProfiles);
                return clientProfiles;
            })
            .catch(error => {
                console.error('Error loading client profiles:', error);
                clientProfiles = [];
                return [];
            });
        }

        function loadStaffProfiles() {
            const currentLocation = getLocationName();
            if (!currentLocation || (currentLocation !== 'The Royal' && currentLocation !== 'The Crown' && currentLocation !== 'Seabreeze')) {
                return Promise.resolve([]);
            }

            // Fetch from Supabase
            return fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/staff_profiles?location=eq.${currentLocation}&select=*`, {
                method: 'GET',
                headers: {
                    'apikey': VISITOR_CONFIG.supabaseAnonKey,
                    'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                staffProfiles = data || [];
                console.log('Loaded staff profiles:', staffProfiles);
                return staffProfiles;
            })
            .catch(error => {
                console.error('Error loading staff profiles:', error);
                staffProfiles = [];
                return [];
            });
        }

        function showAddClientForm() {
            editingClientId = null;
            document.getElementById('clientFormTitle').textContent = 'Add New Client';
            document.getElementById('clientFirstName').value = '';
            document.getElementById('clientLastName').value = '';
            document.getElementById('clientLocation').value = getLocationName();
            resetPhotoPreview();
            showPage('addClientPage');
            saveSessionState();
        }

        function editClient(clientId) {
            const client = clientProfiles.find(c => c.id === clientId);
            if (!client) return;

            editingClientId = clientId;
            document.getElementById('clientFormTitle').textContent = 'Edit Client';
            document.getElementById('clientFirstName').value = client.first_name;
            document.getElementById('clientLastName').value = client.last_name;
            document.getElementById('clientLocation').value = client.location;
            
            if (client.photo_url) {
                document.getElementById('photoPreview').src = client.photo_url;
            } else {
                resetPhotoPreview();
            }
            
            showPage('addClientPage');
            saveSessionState();
        }

        function deleteClient(clientId) {
            const client = clientProfiles.find(c => c.id === clientId);
            if (!client) return;

            if (confirm(`Are you sure you want to delete ${client.first_name} ${client.last_name}?`)) {
                // Remove from local array IMMEDIATELY
                clientProfiles = clientProfiles.filter(c => c.id !== clientId);
                displayClientList();
                
                // Delete from Supabase in background
                fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/client_profiles?id=eq.${clientId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': VISITOR_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        console.log('‚úÖ Client deleted from Supabase');
                    } else {
                        console.log('‚ö†Ô∏è Supabase delete failed, but local delete successful');
                    }
                })
                .catch(error => {
                    console.error('‚ö†Ô∏è Background delete failed:', error);
                });
            }
        }

        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photoPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function resetPhotoPreview() {
            document.getElementById('photoPreview').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Ccircle cx='40' cy='40' r='38' fill='%23f8f9fa' stroke='%23e0e0e0' stroke-width='2'/%3E%3Ctext x='40' y='50' text-anchor='middle' font-size='24' fill='%23666'%3Eüë§%3C/text%3E%3C/svg%3E";
        }

        function saveClientProfile() {
            const firstName = document.getElementById('clientFirstName').value.trim();
            const lastName = document.getElementById('clientLastName').value.trim();
            const location = document.getElementById('clientLocation').value;
            const photoFile = document.getElementById('clientPhoto').files[0];

            if (!firstName || !lastName || !location) {
                alert('Please fill in all required fields.');
                return;
            }

            const saveToDatabase = (photoUrl = null) => {
                const clientData = {
                    first_name: firstName,
                    last_name: lastName,
                    location: location,
                    photo_url: photoUrl
                };

                if (editingClientId) {
                    // Update existing client in local array IMMEDIATELY
                    const index = clientProfiles.findIndex(c => c.id === editingClientId);
                    if (index !== -1) {
                        clientProfiles[index] = { ...clientProfiles[index], ...clientData };
                    }
                    
                    // Show success and move to next screen INSTANTLY (no popup)
                    showPage('clientManagementPage');
                    displayClientList();
                    saveSessionState();
                    
                    // Upload to Supabase in the background (async)
                    updateClientInSupabase(editingClientId, clientData);
                } else {
                    // Create temporary client object with fake ID for immediate display
                    const tempClient = {
                        id: Date.now(), // Temporary ID
                        ...clientData,
                        isTemporary: true
                    };
                    
                    // Add to local array IMMEDIATELY
                    clientProfiles.push(tempClient);
                    
                    // Show success and move to next screen INSTANTLY (no popup)
                    showPage('clientManagementPage');
                    displayClientList();
                    saveSessionState();
                    
                    // Upload to Supabase in the background and update with real ID
                    createClientInSupabase(clientData, tempClient);
                }
            };

            // For simplicity, we'll use data URLs for photos instead of file upload
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveToDatabase(e.target.result);
                };
                reader.readAsDataURL(photoFile);
            } else if (editingClientId) {
                // Keep existing photo for edits
                const existingClient = clientProfiles.find(c => c.id === editingClientId);
                saveToDatabase(existingClient ? existingClient.photo_url : null);
            } else {
                saveToDatabase();
            }
        }

        // Background Supabase operations
        function createClientInSupabase(clientData, tempClient) {
            fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/client_profiles`, {
                method: 'POST',
                headers: {
                    'apikey': VISITOR_CONFIG.supabaseAnonKey,
                    'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(clientData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ Client uploaded to Supabase:', data);
                // Update the temporary client with real Supabase ID
                const tempIndex = clientProfiles.findIndex(c => c.id === tempClient.id);
                if (tempIndex !== -1 && data[0]) {
                    clientProfiles[tempIndex] = { ...data[0], isTemporary: false };
                }
            })
            .catch(error => {
                console.error('‚ö†Ô∏è Background Supabase upload failed:', error);
            });
        }

        function updateClientInSupabase(clientId, clientData) {
            fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/client_profiles?id=eq.${clientId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': VISITOR_CONFIG.supabaseAnonKey,
                    'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(clientData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ Client updated in Supabase:', data);
            })
            .catch(error => {
                console.error('‚ö†Ô∏è Background Supabase update failed:', error);
            });
        }

        function cancelAddClient() {
            showPage('clientManagementPage');
            saveSessionState();
        }

        // Staff Management Functions
        function showAddStaffForm() {
            editingStaffId = null;
            document.getElementById('staffFormTitle').textContent = 'Add New Staff Member';
            document.getElementById('staffFirstName').value = '';
            document.getElementById('staffLastName').value = '';
            document.getElementById('staffLocationSelect').value = getLocationName();
            resetStaffPhotoPreview();
            showPage('addStaffPage');
            saveSessionState();
        }

        function editStaff(staffId) {
            const staff = staffProfiles.find(s => s.id === staffId);
            if (!staff) return;

            editingStaffId = staffId;
            document.getElementById('staffFormTitle').textContent = 'Edit Staff Member';
            document.getElementById('staffFirstName').value = staff.first_name;
            document.getElementById('staffLastName').value = staff.last_name;
            document.getElementById('staffLocationSelect').value = staff.location;
            
            if (staff.photo_url) {
                document.getElementById('staffPhotoPreview').src = staff.photo_url;
            } else {
                resetStaffPhotoPreview();
            }
            
            showPage('addStaffPage');
            saveSessionState();
        }

        function deleteStaff(staffId) {
            const staff = staffProfiles.find(s => s.id === staffId);
            if (!staff) return;

            if (confirm(`Are you sure you want to delete ${staff.first_name} ${staff.last_name}?`)) {
                // Remove from local array IMMEDIATELY
                staffProfiles = staffProfiles.filter(s => s.id !== staffId);
                displayStaffList();
                
                // Delete from Supabase in background
                fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/staff_profiles?id=eq.${staffId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': VISITOR_CONFIG.supabaseAnonKey,
                        'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        console.log('‚úÖ Staff member deleted from Supabase');
                    } else {
                        console.log('‚ö†Ô∏è Supabase delete failed, but local delete successful');
                    }
                })
                .catch(error => {
                    console.error('‚ö†Ô∏è Background delete failed:', error);
                });
            }
        }

        function previewStaffPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('staffPhotoPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function resetStaffPhotoPreview() {
            document.getElementById('staffPhotoPreview').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Ccircle cx='40' cy='40' r='38' fill='%23f8f9fa' stroke='%23e0e0e0' stroke-width='2'/%3E%3Ctext x='40' y='50' text-anchor='middle' font-size='24' fill='%23666'%3Eüë§%3C/text%3E%3C/svg%3E";
        }

        function saveStaffProfile() {
            const firstName = document.getElementById('staffFirstName').value.trim();
            const lastName = document.getElementById('staffLastName').value.trim();
            const location = document.getElementById('staffLocationSelect').value;
            const photoFile = document.getElementById('staffPhoto').files[0];

            if (!firstName || !lastName || !location) {
                alert('Please fill in all required fields.');
                return;
            }

            const saveToDatabase = (photoUrl = null) => {
                const staffData = {
                    first_name: firstName,
                    last_name: lastName,
                    location: location,
                    photo_url: photoUrl
                };

                if (editingStaffId) {
                    // Update existing staff in local array IMMEDIATELY
                    const index = staffProfiles.findIndex(s => s.id === editingStaffId);
                    if (index !== -1) {
                        staffProfiles[index] = { ...staffProfiles[index], ...staffData };
                    }
                    
                    // Show success and move to next screen INSTANTLY (no popup)
                    showPage('staffManagementPage');
                    displayStaffList();
                    saveSessionState();
                    
                    // Upload to Supabase in the background (async)
                    updateStaffInSupabase(editingStaffId, staffData);
                } else {
                    // Create temporary staff object with fake ID for immediate display
                    const tempStaff = {
                        id: Date.now(), // Temporary ID
                        ...staffData,
                        isTemporary: true
                    };
                    
                    // Add to local array IMMEDIATELY
                    staffProfiles.push(tempStaff);
                    
                    // Show success and move to next screen INSTANTLY (no popup)
                    showPage('staffManagementPage');
                    displayStaffList();
                    saveSessionState();
                    
                    // Upload to Supabase in the background and update with real ID
                    createStaffInSupabase(staffData, tempStaff);
                }
            };

            // For simplicity, we'll use data URLs for photos instead of file upload
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveToDatabase(e.target.result);
                };
                reader.readAsDataURL(photoFile);
            } else if (editingStaffId) {
                // Keep existing photo for edits
                const existingStaff = staffProfiles.find(s => s.id === editingStaffId);
                saveToDatabase(existingStaff ? existingStaff.photo_url : null);
            } else {
                saveToDatabase();
            }
        }

        // Background Supabase operations for staff
        function createStaffInSupabase(staffData, tempStaff) {
            fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/staff_profiles`, {
                method: 'POST',
                headers: {
                    'apikey': VISITOR_CONFIG.supabaseAnonKey,
                    'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(staffData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ Staff member uploaded to Supabase:', data);
                // Update the temporary staff with real Supabase ID
                const tempIndex = staffProfiles.findIndex(s => s.id === tempStaff.id);
                if (tempIndex !== -1 && data[0]) {
                    staffProfiles[tempIndex] = { ...data[0], isTemporary: false };
                }
            })
            .catch(error => {
                console.error('‚ö†Ô∏è Background Supabase upload failed:', error);
            });
        }

        function updateStaffInSupabase(staffId, staffData) {
            fetch(`${VISITOR_CONFIG.supabaseUrl}/rest/v1/staff_profiles?id=eq.${staffId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': VISITOR_CONFIG.supabaseAnonKey,
                    'Authorization': `Bearer ${VISITOR_CONFIG.supabaseAnonKey}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(staffData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ Staff member updated in Supabase:', data);
            })
            .catch(error => {
                console.error('‚ö†Ô∏è Background Supabase update failed:', error);
            });
        }

        function cancelAddStaff() {
            showPage('staffManagementPage');
            saveSessionState();
        }

        // Name suggestion functions for departures
        function getCurrentArrivals() {
            const existingData = JSON.parse(localStorage.getItem('hellohubVisitors') || '[]');
            const today = new Date().toLocaleDateString();
            const currentLocation = getLocationName();
            const currentUserType = APP.currentUserType;
            
            return existingData.filter(person => 
                person.arrivalDate === today && 
                person.status === 'arrived' && 
                (!!person.location && person.location.trim().toLowerCase() === currentLocation.trim().toLowerCase()) &&
                person.userType === currentUserType
            );
        }

        function showNameSuggestions() {
            const input = document.getElementById('leaveFirst');
            const suggestionsDiv = document.getElementById('nameSuggestions');
            const searchTerm = input.value.toLowerCase().trim();
            
            if (searchTerm.length < 1) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            const currentArrivals = getCurrentArrivals();
            const matches = currentArrivals.filter(person => 
                person.firstName.toLowerCase().includes(searchTerm)
            );
            
            if (matches.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Build suggestions HTML
            let suggestionsHTML = '';
            matches.forEach((person, index) => {
                const arrivalTime = person.arrivalTime || 'Unknown time';
                suggestionsHTML += `
                    <div class="suggestion-item" data-index="${index}" onclick="selectSuggestion('${person.firstName}', '${person.surname}')" 
                         style="padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s ease;"
                         onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                        <div style="font-weight: bold; color: #333;">${person.firstName} ${person.surname}</div>
                        <div style="font-size: 12px; color: #666;">Arrived: ${arrivalTime}</div>
                        <div style="font-size: 11px; color: #999;">${person.email !== 'Not provided' ? person.email : ''}</div>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = suggestionsHTML;
            suggestionsDiv.style.display = 'block';
            
            // Position the suggestions below the input
            const inputRect = input.getBoundingClientRect();
            suggestionsDiv.style.width = input.offsetWidth + 'px';
        }

        function selectSuggestion(firstName, surname) {
            document.getElementById('leaveFirst').value = firstName;
            document.getElementById('leaveLast').value = surname;
            hideNameSuggestions();
        }

        function hideNameSuggestions() {
            setTimeout(() => {
                const suggestionsDiv = document.getElementById('nameSuggestions');
                if (suggestionsDiv) {
                    suggestionsDiv.style.display = 'none';
                }
            }, 200); // Small delay to allow clicks to register
        }

        // Handle keyboard navigation in suggestions
        let selectedSuggestionIndex = -1;
        function handleSuggestionKeyboard(event) {
            const suggestionsDiv = document.getElementById('nameSuggestions');
            const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');
            
            if (suggestions.length === 0) return;
            
            switch(event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedSuggestionIndex = (selectedSuggestionIndex + 1) % suggestions.length;
                    highlightSuggestion(suggestions);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    selectedSuggestionIndex = selectedSuggestionIndex <= 0 ? suggestions.length - 1 : selectedSuggestionIndex - 1;
                    highlightSuggestion(suggestions);
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (selectedSuggestionIndex >= 0 && suggestions[selectedSuggestionIndex]) {
                        suggestions[selectedSuggestionIndex].click();
                    }
                    break;
                case 'Escape':
                    hideNameSuggestions();
                    selectedSuggestionIndex = -1;
                    break;
            }
        }

        function highlightSuggestion(suggestions) {
            suggestions.forEach((item, index) => {
                if (index === selectedSuggestionIndex) {
                    item.style.background = '#e3f2fd';
                    item.style.borderLeft = '3px solid #2196f3';
                } else {
                    item.style.background = 'white';
                    item.style.borderLeft = 'none';
                }
            });
        }
        function finishClientManagement() { 
            showPage('arrivingPage');
            buildArrivalForm();
            saveSessionState();
        }
        function finishStaffManagement() { 
            showPage('arrivingPage');
            buildArrivalForm();
            saveSessionState();
        }


</script>
</body>
</html>
